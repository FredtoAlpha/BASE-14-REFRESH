<script>
/**
 * GROUPS MODULE V4 - LOADER
 * Connecte l'interface triptyque au bouton Groupes du header
 * et fait le pont avec l'algorithme de r√©partition
 */

(function() {
  'use strict';

  console.log('üîå Initialisation du module Groupes V4...');

  // Container plein √©cran pour l'interface
  let moduleContainer = null;

  /**
   * R√©cup√®re les donn√©es des classes depuis STATE
   */
  function getClassesData() {
    if (!window.STATE) {
      console.error('‚ùå window.STATE non disponible');
      return null;
    }

    // Extraire les √©l√®ves et les organiser par classe
    const students = window.STATE.students || {};
    const classesData = {};

    Object.values(students).forEach(student => {
      const className = student.class || student.classe;
      if (!className) return;

      if (!classesData[className]) {
        classesData[className] = [];
      }

      classesData[className].push({
        id: student.id,
        firstName: student.firstName || student.prenom,
        lastName: student.lastName || student.nom,
        class: className,
        gender: student.gender || student.sexe || 'M',
        score: student.score || 0,
        lv2: student.lv2 || null,
        options: student.options || []
      });
    });

    console.log('üìä Donn√©es des classes extraites:', Object.keys(classesData));
    return classesData;
  }

  /**
   * V√©rifie que les donn√©es sont disponibles
   */
  function validateData() {
    const classesData = getClassesData();

    if (!classesData || Object.keys(classesData).length === 0) {
      console.error('‚ùå Aucune classe trouv√©e dans STATE');
      console.log('Diagnostic :');
      console.log('- STATE existe :', !!window.STATE);
      console.log('- STATE.students existe :', !!window.STATE?.students);
      console.log('- Nombre d\'√©l√®ves :', Object.keys(window.STATE?.students || {}).length);
      return false;
    }

    return true;
  }

  /**
   * Ouvre l'interface du module Groupes V4
   */
  function openModuleGroupsV4(mode) {
    console.log('üöÄ Ouverture du module Groupes V4, mode:', mode);

    // V√©rifier les d√©pendances
    if (!window.GroupsInterfaceV4) {
      console.error('‚ùå GroupsInterfaceV4 non charg√©');
      alert('Erreur : Interface Groupes V4 non disponible');
      return;
    }

    if (!window.GroupsAlgorithmV4) {
      console.error('‚ùå GroupsAlgorithmV4 non charg√©');
      alert('Erreur : Algorithme Groupes V4 non disponible');
      return;
    }

    // Valider les donn√©es
    if (!validateData()) {
      alert('Erreur : Aucune classe disponible. Veuillez charger des donn√©es d\'abord.');
      return;
    }

    // Cr√©er le container plein √©cran
    if (!moduleContainer) {
      moduleContainer = document.createElement('div');
      moduleContainer.id = 'groups-v4-container';
      moduleContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        background: white;
      `;

      // Ajouter un bouton de fermeture
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Fermer';
      closeBtn.style.cssText = `
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 10000;
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      `;
      closeBtn.addEventListener('click', closeModuleGroupsV4);

      moduleContainer.appendChild(closeBtn);
      document.body.appendChild(moduleContainer);
    }

    // Rendre l'interface triptyque
    window.GroupsInterfaceV4.renderInitialStructure(moduleContainer);

    // Afficher le container
    moduleContainer.style.display = 'block';

    console.log('‚úÖ Module Groupes V4 ouvert');
  }

  /**
   * Ferme l'interface du module
   */
  function closeModuleGroupsV4() {
    if (moduleContainer) {
      moduleContainer.style.display = 'none';
      console.log('‚úÖ Module Groupes V4 ferm√©');
    }
  }

  /**
   * G√®re l'√©v√©nement de g√©n√©ration des groupes
   */
  function handleGenerateGroups(event) {
    const { scenario, mode, regroupements } = event.detail;

    console.log('üéØ G√©n√©ration des groupes demand√©e:', { scenario, mode, regroupements });

    try {
      // Pour chaque regroupement, g√©n√©rer les groupes
      const allResults = regroupements.map(regroupement => {
        // R√©cup√©rer les √©l√®ves des classes du regroupement
        const classesData = getClassesData();
        const students = [];

        // Si aucune classe sp√©cifi√©e, prendre toutes les classes
        const classesToUse = regroupement.classes.length > 0
          ? regroupement.classes
          : Object.keys(classesData);

        classesToUse.forEach(className => {
          if (classesData[className]) {
            students.push(...classesData[className]);
          }
        });

        console.log(`üìö Regroupement "${regroupement.name}" : ${students.length} √©l√®ves`);

        // Appeler l'algorithme
        const result = window.GroupsAlgorithmV4.distribute({
          students,
          mode,
          numGroups: regroupement.numGroups,
          scenario
        });

        return {
          regroupement: regroupement.name,
          result
        };
      });

      // Combiner les r√©sultats
      const combinedResults = {
        groups: allResults.flatMap(r => r.result.groups),
        stats: allResults.flatMap(r => r.result.stats),
        metadata: {
          scenario,
          mode,
          totalRegroupements: regroupements.length,
          totalStudents: allResults.reduce((sum, r) => sum + r.result.metadata.totalStudents, 0),
          timestamp: new Date().toISOString()
        }
      };

      // √âmettre l'√©v√©nement de succ√®s
      const successEvent = new CustomEvent('groups:generated', {
        detail: combinedResults
      });
      document.dispatchEvent(successEvent);

      console.log('‚úÖ Groupes g√©n√©r√©s avec succ√®s', combinedResults);

    } catch (error) {
      console.error('‚ùå Erreur lors de la g√©n√©ration:', error);

      // √âmettre l'√©v√©nement d'erreur
      const errorEvent = new CustomEvent('groups:error', {
        detail: { message: error.message }
      });
      document.dispatchEvent(errorEvent);
    }
  }

  /**
   * G√®re l'√©v√©nement de r√©sultats g√©n√©r√©s
   */
  function handleGroupsGenerated(event) {
    console.log('üìä R√©sultats re√ßus:', event.detail);

    // Afficher les r√©sultats dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayResults(event.detail);
    }
  }

  /**
   * G√®re l'√©v√©nement d'erreur
   */
  function handleGroupsError(event) {
    console.error('‚ùå Erreur re√ßue:', event.detail);

    // Afficher l'erreur dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayError(event.detail);
    }
  }

  /**
   * Remplace la fonction openGroupsInterface existante
   */
  function replaceOpenGroupsInterface() {
    // Sauvegarder l'ancienne fonction si elle existe
    if (window.openGroupsInterface) {
      window._oldOpenGroupsInterface = window.openGroupsInterface;
      console.log('üíæ Ancienne openGroupsInterface sauvegard√©e');
    }

    // Remplacer par la nouvelle
    window.openGroupsInterface = function(mode) {
      console.log('üîÑ openGroupsInterface appel√©e avec mode:', mode);

      // Rediriger vers le module V4
      openModuleGroupsV4(mode);
    };

    console.log('‚úÖ openGroupsInterface remplac√©e par la version V4');
  }

  /**
   * Restaure l'ancienne fonction openGroupsInterface
   */
  function restoreOpenGroupsInterface() {
    if (window._oldOpenGroupsInterface) {
      window.openGroupsInterface = window._oldOpenGroupsInterface;
      delete window._oldOpenGroupsInterface;
      console.log('‚úÖ openGroupsInterface restaur√©e');
    }
  }

  /**
   * Initialisation du module
   */
  function init() {
    // √âcouter les √©v√©nements
    document.addEventListener('groups:generate', handleGenerateGroups);
    document.addEventListener('groups:generated', handleGroupsGenerated);
    document.addEventListener('groups:error', handleGroupsError);

    // Remplacer la fonction du header
    replaceOpenGroupsInterface();

    // Exposer les fonctions globalement
    window.openModuleGroupsV4 = openModuleGroupsV4;
    window.closeModuleGroupsV4 = closeModuleGroupsV4;

    console.log('‚úÖ Module Groupes V4 initialis√© et connect√© au header');
  }

  // Initialiser au chargement du DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM d√©j√† charg√©
    setTimeout(init, 100);
  }

  // Nettoyer √† la fermeture
  window.addEventListener('beforeunload', () => {
    restoreOpenGroupsInterface();
  });

})();
</script>
