<script>
/**
 * GROUPS MODULE V4 - LOADER
 * Connecte l'interface triptyque au bouton Groupes du header
 * et fait le pont avec l'algorithme de r√©partition
 */

(function() {
  'use strict';

  console.log('üîå Initialisation du module Groupes V4...');

  // Container plein √©cran pour l'interface
  let moduleContainer = null;

  /**
   * R√©cup√®re les donn√©es des classes depuis le DOM (zones droppables)
   */
  function getClassesData() {
    if (!window.STATE || !window.STATE.students) {
      console.error('‚ùå window.STATE.students non disponible');
      return null;
    }

    // Extraire les classes depuis les zones droppables du DOM
    const zones = document.querySelectorAll('.droppable-zone[data-classe]');
    const classesData = {};

    zones.forEach(zone => {
      const className = zone.getAttribute('data-classe');
      if (!className) return;

      classesData[className] = [];

      // R√©cup√©rer les cartes √©l√®ves dans cette zone
      const cards = zone.querySelectorAll('.student-card');

      cards.forEach(card => {
        const studentId = card.getAttribute('data-id') || card.getAttribute('data-student-id');
        if (!studentId) return;

        // R√©cup√©rer les donn√©es compl√®tes depuis STATE
        const student = window.STATE.students[studentId];

        if (student) {
          // Extraire TOUS les champs n√©cessaires pour l'algorithme V4
          const extractedStudent = {
            id: student.id || studentId,
            firstName: student.firstName || student.prenom || '',
            lastName: student.lastName || student.nom || '',
            class: className,

            // SEXE (colonne E)
            sexe: (student.sexe || student.gender || 'M').toUpperCase(),
            gender: student.gender || student.sexe || 'M',

            // CRIT√àRES COMPORTEMENTAUX
            com: parseFloat(student.com || student.COM || 0),        // Colonne H
            tra: parseFloat(student.tra || student.TRA || 0),        // Colonne I
            part: parseFloat(student.part || student.PART || 0),     // Colonne J
            abs: parseFloat(student.abs || student.ABS || 0),        // Colonne K

            // SCORES ACAD√âMIQUES
            scoreF: parseFloat(student.scoreF || student.scores?.F || 0),  // Colonne U (1-4)
            scoreM: parseFloat(student.scoreM || student.scores?.M || 0),  // Colonne V (1-4)
            score: parseFloat(student.score || student.scoreF || student.scoreM || 0),

            // AUTRES DONN√âES
            // Colonne F : LV2 (ESP par d√©faut si vide)
            lv2: (student.lv2 || student.LV2 || 'ESP').toUpperCase(),
            options: student.options || [],
            scores: student.scores || {}
          };

          // DEBUG: Log premier √©l√®ve de chaque classe pour v√©rifier extraction
          if (classesData[className].length === 0) {
            console.log(`üîç Premier √©l√®ve de ${className}:`, {
              nom: extractedStudent.lastName,
              scoreF: extractedStudent.scoreF,
              scoreM: extractedStudent.scoreM,
              com: extractedStudent.com,
              tra: extractedStudent.tra
            });
          }

          classesData[className].push(extractedStudent);
        }
      });
    });

    console.log('üìä Donn√©es des classes extraites:', Object.keys(classesData));
    console.log('üìä D√©tail:', Object.entries(classesData).map(([c, eleves]) => `${c}: ${eleves.length} √©l√®ves`));

    return classesData;
  }

  /**
   * V√©rifie que les donn√©es sont disponibles
   */
  function validateData() {
    const classesData = getClassesData();

    if (!classesData || Object.keys(classesData).length === 0) {
      console.error('‚ùå Aucune classe trouv√©e dans STATE');
      console.log('Diagnostic :');
      console.log('- STATE existe :', !!window.STATE);
      console.log('- STATE.students existe :', !!window.STATE?.students);
      console.log('- Nombre d\'√©l√®ves :', Object.keys(window.STATE?.students || {}).length);
      return false;
    }

    return true;
  }

  /**
   * Ouvre l'interface du module Groupes V4
   */
  function openModuleGroupsV4(mode) {
    console.log('üöÄ Ouverture du module Groupes V4, mode:', mode);

    // V√©rifier les d√©pendances
    if (!window.GroupsInterfaceV4) {
      console.error('‚ùå GroupsInterfaceV4 non charg√©');
      alert('Erreur : Interface Groupes V4 non disponible');
      return;
    }

    if (!window.GroupsAlgorithmV4) {
      console.error('‚ùå GroupsAlgorithmV4 non charg√©');
      alert('Erreur : Algorithme Groupes V4 non disponible');
      return;
    }

    // V√©rifier que STATE.students est charg√©
    if (!window.STATE || !window.STATE.students || Object.keys(window.STATE.students).length === 0) {
      console.warn('‚ö†Ô∏è STATE.students vide ou non charg√©, attente...');

      // Attendre 1 seconde que les donn√©es se chargent
      setTimeout(() => {
        if (!window.STATE || !window.STATE.students || Object.keys(window.STATE.students).length === 0) {
          alert('Erreur : Les donn√©es des √©l√®ves ne sont pas encore charg√©es. Veuillez attendre la fin du chargement et r√©essayer.');
          console.error('‚ùå STATE.students toujours vide apr√®s d√©lai');
          return;
        }
        // R√©essayer l'ouverture
        openModuleGroupsV4(mode);
      }, 1000);
      return;
    }

    // Valider les donn√©es
    if (!validateData()) {
      alert('Erreur : Aucune classe disponible. Veuillez charger des donn√©es d\'abord.');
      return;
    }

    // Cr√©er le container plein √©cran
    if (!moduleContainer) {
      moduleContainer = document.createElement('div');
      moduleContainer.id = 'groups-v4-container';
      moduleContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        background: white;
      `;

      // Ajouter un bouton de fermeture
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Fermer';
      closeBtn.style.cssText = `
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 10000;
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      `;
      closeBtn.addEventListener('click', closeModuleGroupsV4);

      moduleContainer.appendChild(closeBtn);
      document.body.appendChild(moduleContainer);
    }

    // Rendre l'interface triptyque
    window.GroupsInterfaceV4.renderInitialStructure(moduleContainer);

    // Afficher le container
    moduleContainer.style.display = 'block';

    console.log('‚úÖ Module Groupes V4 ouvert');
  }

  /**
   * Ferme l'interface du module
   */
  function closeModuleGroupsV4() {
    if (moduleContainer) {
      moduleContainer.style.display = 'none';
      console.log('‚úÖ Module Groupes V4 ferm√©');
    }
  }

  /**
   * G√®re l'√©v√©nement de g√©n√©ration des groupes
   */
  function handleGenerateGroups(event) {
    const { scenario, mode, selectedLanguage, regroupements } = event.detail;

    console.log('üéØ G√©n√©ration des groupes demand√©e:', { scenario, mode, selectedLanguage, regroupements });

    try {
      // Pour chaque regroupement, g√©n√©rer les groupes
      const allResults = regroupements.map(regroupement => {
        // R√©cup√©rer les √©l√®ves des classes du regroupement
        const classesData = getClassesData();
        let students = [];

        // Si aucune classe sp√©cifi√©e, prendre toutes les classes
        const classesToUse = regroupement.classes.length > 0
          ? regroupement.classes
          : Object.keys(classesData);

        classesToUse.forEach(className => {
          if (classesData[className]) {
            students.push(...classesData[className]);
          }
        });

        console.log(`üìö Regroupement "${regroupement.name}" : ${students.length} √©l√®ves (avant filtrage)`);

        // FILTRAGE PAR LANGUE pour le sc√©nario LV2
        if (scenario === 'lv2' && selectedLanguage) {
          const beforeFilter = students.length;
          students = students.filter(student => {
            const studentLang = (student.lv2 || 'ESP').toUpperCase();
            return studentLang === selectedLanguage;
          });
          console.log(`üåç Filtrage LV2 (${selectedLanguage}): ${beforeFilter} ‚Üí ${students.length} √©l√®ves`);
        }

        if (students.length === 0) {
          console.warn(`‚ö†Ô∏è Aucun √©l√®ve pour "${regroupement.name}" apr√®s filtrage`);
          return null;
        }

        console.log(`üìö Regroupement "${regroupement.name}" : ${students.length} √©l√®ves (apr√®s filtrage)`);

        // Appeler l'algorithme
        const result = window.GroupsAlgorithmV4.distribute({
          students,
          mode,
          numGroups: regroupement.numGroups,
          scenario
        });

        return {
          regroupement: regroupement.name,
          result
        };
      });

      // Filtrer les r√©sultats null (regroupements vides)
      const validResults = allResults.filter(r => r !== null);

      if (validResults.length === 0) {
        throw new Error('Aucun √©l√®ve trouv√© apr√®s filtrage. V√©rifiez la langue s√©lectionn√©e et les classes.');
      }

      // Combiner les r√©sultats en pr√©servant l'information du regroupement
      const combinedResults = {
        groups: validResults.flatMap(r =>
          r.result.groups.map(group => ({
            ...group,
            regroupementName: r.regroupement, // Ajouter le nom du regroupement
            regroupementId: r.regroupement.replace(/\s+/g, '-').toLowerCase()
          }))
        ),
        stats: validResults.flatMap(r => r.result.stats),
        metadata: {
          scenario,
          mode,
          selectedLanguage,
          totalRegroupements: validResults.length,
          totalStudents: validResults.reduce((sum, r) => sum + r.result.metadata.totalStudents, 0),
          timestamp: new Date().toISOString()
        }
      };

      // √âmettre l'√©v√©nement de succ√®s
      const successEvent = new CustomEvent('groups:generated', {
        detail: combinedResults
      });
      document.dispatchEvent(successEvent);

      console.log('‚úÖ Groupes g√©n√©r√©s avec succ√®s', combinedResults);

    } catch (error) {
      console.error('‚ùå Erreur lors de la g√©n√©ration:', error);

      // √âmettre l'√©v√©nement d'erreur
      const errorEvent = new CustomEvent('groups:error', {
        detail: { message: error.message }
      });
      document.dispatchEvent(errorEvent);
    }
  }

  /**
   * G√®re l'√©v√©nement de r√©sultats g√©n√©r√©s
   */
  function handleGroupsGenerated(event) {
    console.log('üìä R√©sultats re√ßus:', event.detail);

    // Afficher les r√©sultats dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayResults(event.detail);
    }
  }

  /**
   * G√®re l'√©v√©nement d'erreur
   */
  function handleGroupsError(event) {
    console.error('‚ùå Erreur re√ßue:', event.detail);

    // Afficher l'erreur dans l'interface
    if (window.GroupsInterfaceV4) {
      window.GroupsInterfaceV4.displayError(event.detail);
    }
  }

  /**
   * Remplace la fonction openGroupsInterface existante
   */
  function replaceOpenGroupsInterface() {
    // Sauvegarder l'ancienne fonction si elle existe
    if (window.openGroupsInterface) {
      window._oldOpenGroupsInterface = window.openGroupsInterface;
      console.log('üíæ Ancienne openGroupsInterface sauvegard√©e');
    }

    // Remplacer par la nouvelle
    window.openGroupsInterface = function(mode) {
      console.log('üîÑ openGroupsInterface appel√©e avec mode:', mode);

      // Rediriger vers le module V4
      openModuleGroupsV4(mode);
    };

    console.log('‚úÖ openGroupsInterface remplac√©e par la version V4');
  }

  /**
   * Restaure l'ancienne fonction openGroupsInterface
   */
  function restoreOpenGroupsInterface() {
    if (window._oldOpenGroupsInterface) {
      window.openGroupsInterface = window._oldOpenGroupsInterface;
      delete window._oldOpenGroupsInterface;
      console.log('‚úÖ openGroupsInterface restaur√©e');
    }
  }

  /**
   * Initialisation du module
   */
  function init() {
    // √âcouter les √©v√©nements
    document.addEventListener('groups:generate', handleGenerateGroups);
    document.addEventListener('groups:generated', handleGroupsGenerated);
    document.addEventListener('groups:error', handleGroupsError);

    // Remplacer la fonction du header
    replaceOpenGroupsInterface();

    // Exposer les fonctions globalement
    window.openModuleGroupsV4 = openModuleGroupsV4;
    window.closeModuleGroupsV4 = closeModuleGroupsV4;

    console.log('‚úÖ Module Groupes V4 initialis√© et connect√© au header');
  }

  // Initialiser au chargement du DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM d√©j√† charg√©
    setTimeout(init, 100);
  }

  // Nettoyer √† la fermeture
  window.addEventListener('beforeunload', () => {
    restoreOpenGroupsInterface();
  });

})();
</script>
