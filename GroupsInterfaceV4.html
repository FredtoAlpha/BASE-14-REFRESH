<script>
/**
 * GROUPS INTERFACE V4 - TRIPTYQUE
 * Interface utilisateur en trois volets pour la cr√©ation de groupes
 * Architecture : Volet A (30%) - Volet B (40%) - Volet C (30%)
 */

const GroupsInterfaceV4 = (function() {
  'use strict';

  // √âtat interne de l'interface
  const state = {
    scenario: null,        // 'besoins' | 'lv2' | 'options'
    mode: null,           // 'heterogeneous' | 'homogeneous'
    selectedLanguage: null, // 'ESP' | 'ITA' | 'ALL' | 'CHI' | 'ARA' | etc.
    availableLanguages: [], // [{ lang: 'ESP', count: 45 }, ...]
    regroupements: [],    // Liste des regroupements configur√©s
    currentResults: null, // R√©sultats de la g√©n√©ration en cours
    timeline: [],         // Historique des actions
    carouselIndex: 0,     // Index du carrousel de groupes

    // √âtat du dashboard de swap
    swapDashboard: {
      currentRegroupementIndex: 0,  // Index du regroupement affich√©
      allRegroupements: [],          // Tous les regroupements g√©n√©r√©s
      statsVisible: false,           // Panneau statistiques visible
      sidebarCollapsed: false,       // Panneau lat√©ral r√©tract√©
      comparisonVisible: true        // Bandeau comparaison visible
    }
  };

  /**
   * Rendu de la structure HTML compl√®te (triptyque 30/40/30)
   */
  function renderInitialStructure(container) {
    container.innerHTML = `
      <div class="groups-v4-triptyque" style="display: flex; height: 100vh; background: #f8f9fa;">

        <!-- VOLET A : Param√®tres (30%) -->
        <div class="volet-a" style="flex: 0 0 30%; background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%); border-right: 1px solid #e5e7eb; overflow-y: auto;">
          <div style="padding: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #1f2937; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-cog"></i> Param√®tres
            </h2>

            <!-- Sc√©nario -->
            <div style="margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                Choisir un sc√©nario
              </h3>
              <div id="scenario-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <button class="scenario-btn" data-scenario="besoins" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-user-graduate"></i> Besoins p√©dagogiques
                </button>
                <button class="scenario-btn" data-scenario="lv2" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-language"></i> Langues vivantes (LV2)
                </button>
                <button class="scenario-btn" data-scenario="options" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-star"></i> Options sp√©cifiques
                </button>
              </div>
            </div>

            <!-- Mode de distribution -->
            <div id="mode-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                Mode de distribution
              </h3>
              <div id="mode-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <button class="mode-btn" data-mode="heterogeneous" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-random"></i> H√©t√©rog√®ne
                  <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    M√©lange les niveaux pour √©quilibrer
                  </div>
                </button>
                <button class="mode-btn" data-mode="homogeneous" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-equals"></i> Homog√®ne
                  <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    Groupes de niveaux similaires
                  </div>
                </button>
              </div>
            </div>

            <!-- S√©lection de la langue LV2 -->
            <div id="language-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-language"></i> Langue √† regrouper
              </h3>
              <div id="language-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Les langues seront ins√©r√©es ici dynamiquement -->
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> <span id="language-info">S√©lectionnez une langue</span>
              </div>
            </div>

            <!-- Classes d√©tect√©es -->
            <div id="classes-detected-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-school"></i> Classes d√©tect√©es
              </h3>
              <div id="classes-detected-list" style="
                padding: 12px;
                background: #f0fdf4;
                border: 1px solid #86efac;
                border-radius: 8px;
                font-size: 13px;
              ">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <!-- Les classes d√©tect√©es s'afficheront ici -->
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> Ces classes sont disponibles pour cr√©er des regroupements
              </div>
            </div>

            <!-- Aide contextuelle -->
            <div id="help-box" style="
              padding: 12px;
              background: #eff6ff;
              border-left: 4px solid #3b82f6;
              border-radius: 4px;
              font-size: 13px;
              color: #1e40af;
              display: none;
            ">
              <i class="fas fa-info-circle"></i>
              <span id="help-text"></span>
            </div>
          </div>
        </div>

        <!-- VOLET B : Regroupements (40%) -->
        <div class="volet-b" style="flex: 0 0 40%; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); overflow-y: auto;">
          <div style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="fas fa-layer-group"></i> Regroupements
              </h2>
              <button id="btn-add-regroupement" style="
                padding: 8px 16px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: none;
              ">
                <i class="fas fa-plus"></i> Ajouter
              </button>
            </div>

            <div id="regroupements-list" style="display: flex; flex-direction: column; gap: 16px;">
              <div id="regroupements-placeholder" style="
                padding: 48px 24px;
                text-align: center;
                color: #9ca3af;
                border: 2px dashed #e5e7eb;
                border-radius: 8px;
              ">
                <i class="fas fa-arrow-left" style="font-size: 24px; margin-bottom: 16px;"></i>
                <div style="font-size: 14px;">
                  S√©lectionnez un sc√©nario et un mode pour commencer
                </div>
              </div>
            </div>

            <!-- Bandeau d'actions -->
            <div id="actions-banner" style="
              display: none;
              margin-top: 24px;
              padding: 16px;
              background: white;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
            ">
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="btn-reset" style="
                  padding: 10px 20px;
                  background: #ef4444;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                ">
                  <i class="fas fa-redo"></i> R√©initialiser
                </button>
                <button id="btn-generate" style="
                  padding: 10px 20px;
                  background: #3b82f6;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 500;
                ">
                  <i class="fas fa-magic"></i> G√©n√©rer les groupes
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- VOLET C : R√©capitulatif (30%) -->
        <div class="volet-c" style="flex: 0 0 30%; background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%); border-left: 1px solid #e5e7eb; overflow-y: auto;">
          <div style="padding: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-chart-bar"></i> R√©capitulatif
            </h2>

            <!-- Sc√©nario et mode s√©lectionn√©s -->
            <div id="recap-selection" style="
              padding: 16px;
              background: #f9fafb;
              border-radius: 8px;
              margin-bottom: 24px;
              font-size: 14px;
            ">
              <div style="margin-bottom: 8px;">
                <strong>Sc√©nario :</strong> <span id="recap-scenario">-</span>
              </div>
              <div style="margin-bottom: 8px;">
                <strong>Mode :</strong> <span id="recap-mode">-</span>
              </div>
              <div id="recap-language-row" style="display: none;">
                <strong>Langue :</strong> <span id="recap-language">-</span>
              </div>
            </div>

            <!-- Statistiques -->
            <div id="recap-stats" style="display: none; margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-chart-pie"></i> Statistiques
              </h3>
              <div id="stats-content"></div>
            </div>

            <!-- Timeline -->
            <div id="recap-timeline" style="margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-clock"></i> Timeline
              </h3>
              <div id="timeline-content" style="
                font-size: 13px;
                color: #6b7280;
              ">
                Aucune action pour le moment
              </div>
            </div>

            <!-- Aper√ßu des groupes (carrousel) -->
            <div id="recap-groups" style="display: none;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-users"></i> Aper√ßu des groupes
              </h3>
              <div id="groups-carousel"></div>
            </div>

            <!-- Interface de swap -->
            <div id="recap-swap-section" style="display: none; margin-top: 24px;">
              <button id="btn-open-swap" style="
                width: 100%;
                padding: 14px 20px;
                background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                transition: all 0.2s;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'">
                <i class="fas fa-exchange-alt"></i> Ouvrir l'interface de swap
              </button>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280; text-align: center;">
                <i class="fas fa-info-circle"></i> √âchangez les √©l√®ves entre les groupes
              </div>
            </div>
          </div>
        </div>

      </div>
    `;

    // Initialiser les √©v√©nements
    initializeEvents(container);
  }

  /**
   * Initialise les √©v√©nements de l'interface
   */
  function initializeEvents(container) {
    // Boutons de sc√©nario
    container.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => selectScenario(btn.dataset.scenario));
    });

    // Boutons de mode
    container.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => selectMode(btn.dataset.mode));
    });

    // Bouton ajouter regroupement
    const btnAdd = container.querySelector('#btn-add-regroupement');
    if (btnAdd) {
      btnAdd.addEventListener('click', addRegroupement);
    }

    // Bouton g√©n√©rer
    const btnGenerate = container.querySelector('#btn-generate');
    if (btnGenerate) {
      btnGenerate.addEventListener('click', generateGroups);
    }

    // Bouton r√©initialiser
    const btnReset = container.querySelector('#btn-reset');
    if (btnReset) {
      btnReset.addEventListener('click', resetInterface);
    }

    // Bouton ouvrir swap interface
    const btnOpenSwap = container.querySelector('#btn-open-swap');
    if (btnOpenSwap) {
      btnOpenSwap.addEventListener('click', openSwapInterface);
    }
  }

  /**
   * S√©lection du sc√©nario
   */
  function selectScenario(scenario) {
    state.scenario = scenario;

    // Mettre √† jour l'UI
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      if (btn.dataset.scenario === scenario) {
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#eff6ff';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section mode
    const modeSection = document.getElementById('mode-section');
    if (modeSection) modeSection.style.display = 'block';

    // Si sc√©nario LV2, afficher le s√©lecteur de langue
    if (scenario === 'lv2') {
      displayLanguageSelection();
    } else {
      // Masquer la section langue pour les autres sc√©narios
      const languageSection = document.getElementById('language-section');
      if (languageSection) languageSection.style.display = 'none';
      state.selectedLanguage = null;
    }

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Sc√©nario "${scenario}" s√©lectionn√©`);

    console.log('‚úÖ Sc√©nario s√©lectionn√©:', scenario);
  }

  /**
   * S√©lection du mode
   */
  function selectMode(mode) {
    state.mode = mode;

    // Mettre √† jour l'UI
    document.querySelectorAll('.mode-btn').forEach(btn => {
      if (btn.dataset.mode === mode) {
        btn.style.borderColor = '#10b981';
        btn.style.background = '#f0fdf4';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section des classes d√©tect√©es
    displayDetectedClasses();

    // Activer le volet B
    activateVoletB();

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Mode "${mode}" s√©lectionn√©`);

    console.log('‚úÖ Mode s√©lectionn√©:', mode);
  }

  /**
   * Affiche la liste des classes d√©tect√©es depuis le DOM
   */
  function displayDetectedClasses() {
    const section = document.getElementById('classes-detected-section');
    const listContainer = document.querySelector('#classes-detected-list > div');

    if (!section || !listContainer) return;

    // D√©tecter les classes depuis le DOM
    const zones = document.querySelectorAll('.droppable-zone[data-classe]');
    const classes = [];
    zones.forEach(zone => {
      const className = zone.getAttribute('data-classe');
      if (className && !classes.includes(className)) {
        classes.push(className);
      }
    });

    if (classes.length === 0) {
      listContainer.innerHTML = '<span style="color: #ef4444;">Aucune classe d√©tect√©e</span>';
    } else {
      listContainer.innerHTML = classes.map(className => `
        <span style="
          display: inline-block;
          padding: 4px 10px;
          background: white;
          border: 1px solid #10b981;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          color: #059669;
        ">
          <i class="fas fa-graduation-cap" style="margin-right: 4px;"></i>${className}
        </span>
      `).join('');
    }

    // Afficher la section
    section.style.display = 'block';

    console.log(`‚úÖ ${classes.length} classe(s) d√©tect√©e(s):`, classes);
  }

  /**
   * D√©tecte les langues LV2 disponibles depuis les donn√©es
   */
  function detectAvailableLanguages() {
    if (!window.STATE || !window.STATE.students) {
      console.warn('‚ö†Ô∏è STATE.students non disponible pour d√©tecter les langues');
      return [];
    }

    // Compter les √©l√®ves par langue
    const languageCounts = {};

    Object.values(window.STATE.students).forEach(student => {
      const lang = (student.lv2 || student.LV2 || 'ESP').toUpperCase();
      languageCounts[lang] = (languageCounts[lang] || 0) + 1;
    });

    // Convertir en tableau
    const languages = Object.entries(languageCounts).map(([lang, count]) => ({
      lang,
      count
    }));

    // Trier par nombre d'√©l√®ves d√©croissant
    languages.sort((a, b) => b.count - a.count);

    console.log('üåç Langues d√©tect√©es:', languages);
    return languages;
  }

  /**
   * Affiche le s√©lecteur de langues
   */
  function displayLanguageSelection() {
    const section = document.getElementById('language-section');
    const buttonsContainer = document.getElementById('language-buttons');
    const infoSpan = document.getElementById('language-info');

    if (!section || !buttonsContainer || !infoSpan) return;

    // D√©tecter les langues disponibles
    state.availableLanguages = detectAvailableLanguages();

    if (state.availableLanguages.length === 0) {
      buttonsContainer.innerHTML = '<p style="color: #ef4444; font-size: 13px;">Aucune langue d√©tect√©e</p>';
      section.style.display = 'block';
      return;
    }

    // Afficher les langues sous forme de boutons
    buttonsContainer.innerHTML = state.availableLanguages.map(({ lang, count }) => {
      const langNames = {
        'ESP': 'Espagnol üá™üá∏',
        'ITA': 'Italien üáÆüáπ',
        'ALL': 'Allemand üá©üá™',
        'CHI': 'Chinois üá®üá≥',
        'ARA': 'Arabe üá¶üá™'
      };
      const displayName = langNames[lang] || `${lang} üåç`;

      return `
        <button class="language-btn" data-language="${lang}" style="
          padding: 12px 16px;
          border: 2px solid ${state.selectedLanguage === lang ? '#8b5cf6' : '#e5e7eb'};
          border-radius: 8px;
          background: ${state.selectedLanguage === lang ? '#f3e8ff' : 'white'};
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span style="font-weight: ${state.selectedLanguage === lang ? '600' : '400'};">
            ${displayName}
          </span>
          <span style="
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
          ">
            ${count}
          </span>
        </button>
      `;
    }).join('');

    // Mettre √† jour le texte d'info
    if (state.selectedLanguage) {
      const selectedLang = state.availableLanguages.find(l => l.lang === state.selectedLanguage);
      if (selectedLang) {
        infoSpan.textContent = `${selectedLang.count} √©l√®ve(s) en ${state.selectedLanguage}`;
      }
    } else {
      infoSpan.textContent = 'S√©lectionnez une langue';
    }

    // Afficher la section
    section.style.display = 'block';

    // Attacher les √©v√©nements
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', () => selectLanguage(btn.dataset.language));
    });
  }

  /**
   * S√©lectionne une langue
   */
  function selectLanguage(language) {
    state.selectedLanguage = language;

    // Mettre √† jour l'UI
    displayLanguageSelection();

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Langue "${language}" s√©lectionn√©e`);

    console.log('‚úÖ Langue s√©lectionn√©e:', language);
  }

  /**
   * Active le volet B (regroupements)
   */
  function activateVoletB() {
    const placeholder = document.getElementById('regroupements-placeholder');
    const btnAdd = document.getElementById('btn-add-regroupement');
    const actionsBanner = document.getElementById('actions-banner');

    if (placeholder) placeholder.style.display = 'none';
    if (btnAdd) btnAdd.style.display = 'inline-block';
    if (actionsBanner) actionsBanner.style.display = 'block';
  }

  /**
   * Ajoute un regroupement
   */
  function addRegroupement() {
    const regroupement = {
      id: Date.now(),
      name: `Regroupement ${state.regroupements.length + 1}`,
      classes: [],
      numGroups: 3
    };

    state.regroupements.push(regroupement);
    renderRegroupements();
    addToTimeline(`Regroupement "${regroupement.name}" ajout√©`);
  }

  /**
   * Rendu de la liste des regroupements
   */
  function renderRegroupements() {
    const list = document.getElementById('regroupements-list');
    if (!list) return;

    // R√©cup√©rer les classes disponibles depuis window.STATE
    const availableClasses = [];
    if (window.STATE && window.STATE.students) {
      const zones = document.querySelectorAll('.droppable-zone[data-classe]');
      zones.forEach(zone => {
        const className = zone.getAttribute('data-classe');
        if (className && !availableClasses.includes(className)) {
          availableClasses.push(className);
        }
      });
    }

    list.innerHTML = state.regroupements.map(reg => `
      <div class="regroupement-card" data-id="${reg.id}" style="
        padding: 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <input
            type="text"
            value="${reg.name}"
            data-id="${reg.id}"
            class="regroupement-name"
            style="
              font-weight: 500;
              border: none;
              background: transparent;
              outline: none;
              font-size: 14px;
            "
          />
          <div style="display: flex; gap: 8px;">
            <button class="btn-duplicate" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
            ">
              <i class="fas fa-copy"></i>
            </button>
            <button class="btn-delete" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
              color: #ef4444;
            ">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- S√©lection des classes -->
        <div style="margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px;">
            S√©lectionner les classes :
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${availableClasses.map(className => `
              <label style="
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                border: 2px solid ${reg.classes && reg.classes.includes(className) ? '#3b82f6' : '#e5e7eb'};
                background: ${reg.classes && reg.classes.includes(className) ? '#eff6ff' : 'white'};
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
              ">
                <input
                  type="checkbox"
                  class="class-checkbox"
                  data-regroupement-id="${reg.id}"
                  data-class-name="${className}"
                  ${reg.classes && reg.classes.includes(className) ? 'checked' : ''}
                  style="margin-right: 6px;"
                />
                ${className}
              </label>
            `).join('')}
          </div>
        </div>

        <div style="font-size: 13px; color: #6b7280;">
          <div style="margin-bottom: 8px;">
            <strong>Classes s√©lectionn√©es :</strong>
            <span id="classes-${reg.id}">
              ${reg.classes && reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune'}
            </span>
          </div>
          <div style="margin-top: 8px;">
            Nombre de groupes :
            <input
              type="number"
              value="${reg.numGroups}"
              min="2"
              max="10"
              data-id="${reg.id}"
              class="num-groups-input"
              style="
                width: 60px;
                padding: 4px 8px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                text-align: center;
              "
            />
          </div>
        </div>
      </div>
    `).join('');

    // R√©attacher les √©v√©nements
    attachRegroupementEvents();
  }

  /**
   * Attache les √©v√©nements aux cartes de regroupement
   */
  function attachRegroupementEvents() {
    // Checkboxes de s√©lection de classes
    document.querySelectorAll('.class-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const regId = parseInt(e.target.dataset.regroupementId);
        const className = e.target.dataset.className;
        const reg = state.regroupements.find(r => r.id === regId);

        if (reg) {
          if (!reg.classes) reg.classes = [];

          if (e.target.checked) {
            if (!reg.classes.includes(className)) {
              reg.classes.push(className);
            }
          } else {
            reg.classes = reg.classes.filter(c => c !== className);
          }

          // Mettre √† jour l'affichage
          const display = document.getElementById(`classes-${regId}`);
          if (display) {
            display.textContent = reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune';
          }

          addToTimeline(`"${reg.name}" : ${reg.classes.length} classe(s) s√©lectionn√©e(s)`);
        }
      });
    });

    // Renommer
    document.querySelectorAll('.regroupement-name').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.name = e.target.value;
          addToTimeline(`"${reg.name}" renomm√©`);
        }
      });
    });

    // Changer le nombre de groupes
    document.querySelectorAll('.num-groups-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.numGroups = parseInt(e.target.value);
          addToTimeline(`"${reg.name}" : ${reg.numGroups} groupes`);
        }
      });
    });

    // Dupliquer
    document.querySelectorAll('.btn-duplicate').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          const duplicate = {
            ...reg,
            id: Date.now(),
            name: `${reg.name} (copie)`,
            classes: [...(reg.classes || [])]
          };
          state.regroupements.push(duplicate);
          renderRegroupements();
          addToTimeline(`"${duplicate.name}" cr√©√© par duplication`);
        }
      });
    });

    // Supprimer
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg && confirm(`Supprimer "${reg.name}" ?`)) {
          state.regroupements = state.regroupements.filter(r => r.id !== id);
          renderRegroupements();
          addToTimeline(`"${reg.name}" supprim√©`);
        }
      });
    });
  }

  /**
   * G√©n√®re les groupes
   */
  function generateGroups() {
    if (!state.scenario || !state.mode) {
      alert('Veuillez s√©lectionner un sc√©nario et un mode');
      return;
    }

    // Pour LV2, v√©rifier qu'une langue est s√©lectionn√©e
    if (state.scenario === 'lv2' && !state.selectedLanguage) {
      alert('Veuillez s√©lectionner une langue pour le sc√©nario LV2');
      return;
    }

    if (state.regroupements.length === 0) {
      alert('Veuillez ajouter au moins un regroupement');
      return;
    }

    // √âmettre l'√©v√©nement
    const event = new CustomEvent('groups:generate', {
      detail: {
        scenario: state.scenario,
        mode: state.mode,
        selectedLanguage: state.selectedLanguage, // Ajout de la langue s√©lectionn√©e
        regroupements: state.regroupements
      }
    });

    document.dispatchEvent(event);
    console.log('üöÄ √âv√©nement groups:generate √©mis', event.detail);

    addToTimeline('G√©n√©ration des groupes lanc√©e...');
  }

  /**
   * R√©initialise l'interface
   */
  function resetInterface() {
    if (!confirm('R√©initialiser tous les regroupements ?')) return;

    state.regroupements = [];
    state.currentResults = null;
    renderRegroupements();
    addToTimeline('Interface r√©initialis√©e');
  }

  /**
   * Met √† jour le r√©capitulatif
   */
  function updateRecap() {
    const recapScenario = document.getElementById('recap-scenario');
    const recapMode = document.getElementById('recap-mode');
    const recapLanguageRow = document.getElementById('recap-language-row');
    const recapLanguage = document.getElementById('recap-language');

    if (recapScenario) {
      recapScenario.textContent = state.scenario || '-';
    }

    if (recapMode) {
      recapMode.textContent = state.mode || '-';
    }

    // Afficher la langue si sc√©nario LV2
    if (recapLanguageRow && recapLanguage) {
      if (state.scenario === 'lv2') {
        recapLanguageRow.style.display = 'block';
        recapLanguage.textContent = state.selectedLanguage || '-';
      } else {
        recapLanguageRow.style.display = 'none';
      }
    }
  }

  /**
   * Ajoute une entr√©e √† la timeline
   */
  function addToTimeline(message) {
    const timestamp = new Date().toLocaleTimeString('fr-FR');
    state.timeline.push({ timestamp, message });

    const timelineContent = document.getElementById('timeline-content');
    if (timelineContent) {
      const entry = document.createElement('div');
      entry.style.marginBottom = '8px';
      entry.innerHTML = `
        <span style="color: #9ca3af;">[${timestamp}]</span>
        ${message}
      `;
      timelineContent.appendChild(entry);

      // Scroll vers le bas
      timelineContent.scrollTop = timelineContent.scrollHeight;
    }
  }

  /**
   * Affiche les r√©sultats de g√©n√©ration
   */
  function displayResults(results) {
    console.log('üîç DEBUG displayResults - R√©sultats re√ßus:', {
      totalGroups: results.groups?.length,
      firstGroup: results.groups?.[0] ? {
        name: results.groups[0].name,
        studentCount: results.groups[0].students?.length,
        firstStudent: results.groups[0].students?.[0]
      } : null
    });

    state.currentResults = results;

    // Afficher les statistiques
    const statsSection = document.getElementById('recap-stats');
    const statsContent = document.getElementById('stats-content');

    if (statsSection && statsContent) {
      statsSection.style.display = 'block';
      statsContent.innerHTML = `
        <div style="font-size: 13px;">
          <div style="margin-bottom: 4px;">
            <strong>Groupes g√©n√©r√©s :</strong> ${results.stats.length}
          </div>
          <div style="margin-bottom: 4px;">
            <strong>Total √©l√®ves :</strong> ${results.metadata.totalStudents}
          </div>
        </div>
      `;
    }

    // Afficher la section swap
    const swapSection = document.getElementById('recap-swap-section');
    if (swapSection) {
      swapSection.style.display = 'block';
    }

    addToTimeline(`${results.stats.length} groupes g√©n√©r√©s avec succ√®s`);
  }

  /**
   * Ouvre l'interface de swap - DASHBOARD MODERNE
   */
  function openSwapInterface() {
    if (!state.currentResults || !state.currentResults.groups) {
      alert('Aucun groupe √† afficher. Veuillez d\'abord g√©n√©rer les groupes.');
      return;
    }

    // Organiser les groupes par regroupement
    organizeGroupsByRegroupement();

    if (state.swapDashboard.allRegroupements.length === 0) {
      alert('Aucun regroupement disponible.');
      return;
    }

    // Cr√©er le dashboard plein √©cran
    const dashboard = document.createElement('div');
    dashboard.id = 'swap-dashboard';
    dashboard.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    `;

    dashboard.innerHTML = `
      <!-- Bouton fermeture (coin sup√©rieur droit) -->
      <button id="close-dashboard" style="
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 10001;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        transition: all 0.2s;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        <i class="fas fa-times"></i> Fermer
      </button>

      <!-- EN-T√äTE 3 ZONES -->
      <div style="
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 20px 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 24px; max-width: 100%; margin: 0 auto;">

          <!-- ZONE GAUCHE : CAGLE & APPC -->
          <div style="flex: 1; display: flex; gap: 12px; align-items: center;">
            <button id="btn-toggle-stats" style="
              padding: 10px 18px;
              background: ${state.swapDashboard.statsVisible ? '#3b82f6' : 'rgba(255, 255, 255, 0.2)'};
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">
              <i class="fas fa-chart-bar"></i> Statistiques
            </button>
            <button id="btn-regenerate" style="
              padding: 10px 18px;
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">
              <i class="fas fa-sync-alt"></i> R√©g√©n√©rer
            </button>
          </div>

          <!-- ZONE CENTRE : NAVIGATION REGROUPEMENTS + SAUVEGARDES -->
          <div style="flex: 2; display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <!-- Navigation regroupements -->
            <div style="display: flex; align-items: center; gap: 16px;">
              <button id="btn-prev-regroupement" style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.2s;
              " ${state.swapDashboard.currentRegroupementIndex === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                <i class="fas fa-chevron-left"></i>
              </button>

              <div style="
                background: rgba(255, 255, 255, 0.95);
                color: #6366f1;
                padding: 10px 24px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 700;
                min-width: 220px;
                text-align: center;
              ">
                <span id="regroupement-name">Regroupement 1</span>
                <span style="font-size: 13px; font-weight: 400; color: #9ca3af; margin-left: 8px;">
                  (<span id="regroupement-counter">1</span> / ${state.swapDashboard.allRegroupements.length})
                </span>
              </div>

              <button id="btn-next-regroupement" style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.2s;
              " ${state.swapDashboard.currentRegroupementIndex === state.swapDashboard.allRegroupements.length - 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>

            <!-- Boutons sauvegardes -->
            <div style="display: flex; gap: 10px;">
              <button id="btn-load" style="
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.2s;
              ">
                <i class="fas fa-folder-open"></i> Charger
              </button>
              <button id="btn-save-temp" style="
                padding: 8px 16px;
                background: #f97316;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
                transition: all 0.2s;
              ">
                <i class="fas fa-save"></i> Sauver TEMP
              </button>
              <button id="btn-finalize" style="
                padding: 8px 16px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                transition: all 0.2s;
              ">
                <i class="fas fa-check-circle"></i> Finaliser
              </button>
            </div>
          </div>

          <!-- ZONE DROITE : EXPORTS -->
          <div style="flex: 1; display: flex; gap: 12px; justify-content: flex-end; align-items: center;">
            <button id="btn-export-pdf" style="
              padding: 10px 18px;
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">
              <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button id="btn-export-csv" style="
              padding: 10px 18px;
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              transition: all 0.2s;
            ">
              <i class="fas fa-file-csv"></i> Export CSV
            </button>
          </div>

        </div>
      </div>

      <!-- CONTENU PRINCIPAL -->
      <div style="
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      ">
        <!-- Panneau statistiques (superpos√©, gauche) -->
        <div id="stats-panel" style="
          position: absolute;
          top: 0;
          left: ${state.swapDashboard.statsVisible ? '0' : '-350px'};
          width: 350px;
          height: 100%;
          background: white;
          box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
          overflow-y: auto;
          transition: left 0.3s ease;
          z-index: 100;
          padding: 24px;
        ">
          <h3 style="
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: #6366f1;
            border-bottom: 2px solid #8b5cf6;
            padding-bottom: 12px;
          ">
            <i class="fas fa-chart-pie"></i> Statistiques Globales
          </h3>
          <div id="stats-panel-content"></div>
        </div>

        <!-- Zone groupes (centre) -->
        <div id="groups-zone" style="
          flex: 1;
          overflow-y: auto;
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        ">
          <!-- Bandeau comparaison stats -->
          <div id="stats-comparison-banner" style="
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 3px solid #6d28d9;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 16px rgba(109, 40, 217, 0.2);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
              <h3 style="font-size: 17px; font-weight: 700; color: #6d28d9; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-chart-bar"></i> Comparaison des groupes
              </h3>
              <button id="btn-toggle-comparison" style="
                padding: 6px 12px;
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                color: #6b7280;
              ">
                <i class="fas fa-chevron-up"></i> R√©duire
              </button>
            </div>
            <div id="stats-comparison-content"></div>
          </div>

          <!-- Container groupes responsive -->
          <div id="swap-groups-container" style="
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
          "></div>
        </div>

        <!-- Panneau lat√©ral droit (statistiques distribution) -->
        <div id="sidebar-panel" style="
          width: ${state.swapDashboard.sidebarCollapsed ? '60px' : '320px'};
          background: white;
          border-left: 2px solid #e5e7eb;
          overflow-y: auto;
          transition: width 0.3s ease;
          padding: ${state.swapDashboard.sidebarCollapsed ? '16px 8px' : '24px'};
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="
              font-size: ${state.swapDashboard.sidebarCollapsed ? '0' : '16px'};
              font-weight: 700;
              color: #6366f1;
              margin: 0;
              white-space: nowrap;
              overflow: hidden;
            ">
              <i class="fas fa-chart-line"></i> Distribution des scores
            </h3>
            <button id="btn-toggle-sidebar" style="
              background: #f3f4f6;
              border: 1px solid #e5e7eb;
              padding: 6px 10px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              color: #6b7280;
            ">
              <i class="fas fa-chevron-${state.swapDashboard.sidebarCollapsed ? 'left' : 'right'}"></i>
            </button>
          </div>
          <div id="sidebar-content" style="display: ${state.swapDashboard.sidebarCollapsed ? 'none' : 'block'};"></div>
        </div>
      </div>
    `;

    document.body.appendChild(dashboard);

    // Initialiser le contenu
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();
    attachDashboardEvents();

    console.log('‚úÖ Dashboard de swap ouvert');
  }

  /**
   * Rendu des groupes dans l'interface de swap - NOUVEAU DESIGN
   */
  function renderSwapGroups(groups) {
    return groups.map((group, groupIndex) => {
      // Calculer les statistiques du groupe
      const total = group.students.length;
      const girls = group.students.filter(s => s.sexe === 'F').length;
      const boys = total - girls;

      // Moyenne g√©n√©rale (scoreF + scoreM) / 2
      const avgScore = total > 0
        ? (group.students.reduce((sum, s) => sum + ((parseFloat(s.scoreF) || 0) + (parseFloat(s.scoreM) || 0)) / 2, 0) / total).toFixed(1)
        : '0.0';

      return `
        <div class="swap-group" data-group-index="${groupIndex}" style="
          background: white;
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          flex: 1;
          min-width: 0;
          display: flex;
          flex-direction: column;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        ">
          <!-- EN-T√äTE DU GROUPE -->
          <div style="
            background: linear-gradient(135deg, #6d28d9 0%, #4f46e5 100%);
            color: white;
            padding: 16px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
          ">
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
              ${group.name}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
              <span>
                <i class="fas fa-users"></i> ${total} √©l√®ve${total > 1 ? 's' : ''}
              </span>
              <span>
                <i class="fas fa-venus" style="color: #fcd34d;"></i> ${girls}F /
                <i class="fas fa-mars" style="color: #93c5fd;"></i> ${boys}M
              </span>
              <span style="
                background: rgba(255, 255, 255, 0.25);
                padding: 5px 12px;
                border-radius: 6px;
                font-weight: 700;
                border: 1px solid rgba(255, 255, 255, 0.3);
              ">
                Moy ${avgScore}
              </span>
            </div>
          </div>

          <!-- LISTE DES √âL√àVES -->
          <div class="swap-students-list" data-group-index="${groupIndex}" style="
            padding: 12px;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
          ">
            ${group.students.length === 0 ? `
              <div style="
                padding: 24px;
                text-align: center;
                color: #9ca3af;
                font-size: 13px;
                border: 2px dashed #e5e7eb;
                border-radius: 8px;
              ">
                <i class="fas fa-inbox"></i><br>
                Aucun √©l√®ve
              </div>
            ` : group.students.map((student, studentIndex) => {
              const isCOM1 = (student.com || 0) === 1;
              const scoreF = parseFloat(student.scoreF) || 0;
              const scoreM = parseFloat(student.scoreM) || 0;
              const genderIcon = student.sexe === 'F'
                ? '<i class="fas fa-circle" style="color: #ec4899;"></i>'
                : '<i class="fas fa-circle" style="color: #3b82f6;"></i>';

              return `
                <div
                  class="swap-student-card"
                  draggable="true"
                  data-group-index="${groupIndex}"
                  data-student-index="${studentIndex}"
                  data-student-id="${student.id}"
                  style="
                    padding: 12px;
                    background: #f9fafb;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    cursor: move;
                    font-size: 13px;
                    transition: all 0.2s;
                  "
                  onmouseover="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.2)'; this.style.transform='translateX(4px)'"
                  onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateX(0)'"
                >
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                      ${genderIcon}
                      <span style="
                        font-weight: 600;
                        color: ${isCOM1 ? '#ef4444' : '#374151'};
                        ${isCOM1 ? 'text-decoration: underline;' : ''}
                      ">
                        ${student.lastName} ${student.firstName}
                      </span>
                      ${student.class ? `
                        <span style="
                          font-size: 11px;
                          padding: 2px 6px;
                          background: #dbeafe;
                          color: #1e40af;
                          border-radius: 4px;
                        ">${student.class}</span>
                      ` : ''}
                    </div>
                    <i class="fas fa-grip-vertical" style="color: #d1d5db;"></i>
                  </div>

                  <!-- Badges scores -->
                  <div style="display: flex; gap: 6px;">
                    <span style="
                      display: inline-block;
                      padding: 4px 10px;
                      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                      color: white;
                      border-radius: 5px;
                      font-size: 11px;
                      font-weight: 700;
                      box-shadow: 0 2px 4px rgba(124, 58, 237, 0.3);
                      letter-spacing: 0.3px;
                    ">
                      F: ${scoreF.toFixed(1)}
                    </span>
                    <span style="
                      display: inline-block;
                      padding: 4px 10px;
                      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
                      color: white;
                      border-radius: 5px;
                      font-size: 11px;
                      font-weight: 700;
                      box-shadow: 0 2px 4px rgba(67, 56, 202, 0.3);
                      letter-spacing: 0.3px;
                    ">
                      M: ${scoreM.toFixed(1)}
                    </span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * Organise les groupes par regroupement
   */
  function organizeGroupsByRegroupement() {
    if (!state.currentResults || !state.currentResults.groups) {
      state.swapDashboard.allRegroupements = [];
      return;
    }

    // Grouper par regroupement en utilisant la propri√©t√© regroupementName
    const regroupementMap = {};

    state.currentResults.groups.forEach((group, index) => {
      const regroupementName = group.regroupementName || 'Regroupement 1';

      if (!regroupementMap[regroupementName]) {
        regroupementMap[regroupementName] = {
          name: regroupementName,
          groups: [],
          groupCounter: 1
        };
      }

      // Renommer le groupe avec hi√©rarchie claire
      const renamedGroup = {
        ...group,
        originalName: group.name,
        name: `Groupe ${regroupementMap[regroupementName].groupCounter}`
      };

      regroupementMap[regroupementName].groups.push(renamedGroup);
      regroupementMap[regroupementName].groupCounter++;
    });

    state.swapDashboard.allRegroupements = Object.values(regroupementMap);
    state.swapDashboard.currentRegroupementIndex = 0;

    console.log('üìä Regroupements organis√©s:', state.swapDashboard.allRegroupements.length);
    state.swapDashboard.allRegroupements.forEach((reg, i) => {
      console.log(`  - ${reg.name}: ${reg.groups.length} groupes`);
    });
  }

  /**
   * Rendu du regroupement courant
   */
  function renderCurrentRegroupement() {
    const container = document.getElementById('swap-groups-container');
    if (!container) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      container.innerHTML = '<p style="color: #9ca3af;">Aucun regroupement disponible</p>';
      return;
    }

    // Mettre √† jour le nom et le compteur
    const nameEl = document.getElementById('regroupement-name');
    const counterEl = document.getElementById('regroupement-counter');
    if (nameEl) nameEl.textContent = currentReg.name;
    if (counterEl) counterEl.textContent = state.swapDashboard.currentRegroupementIndex + 1;

    // DEBUG: V√©rifier les donn√©es avant le rendu
    console.log('üîç DEBUG renderCurrentRegroupement - Premier groupe:', {
      name: currentReg.groups[0]?.name,
      studentCount: currentReg.groups[0]?.students.length,
      firstStudent: currentReg.groups[0]?.students[0] ? {
        nom: currentReg.groups[0].students[0].lastName,
        scoreF: currentReg.groups[0].students[0].scoreF,
        scoreM: currentReg.groups[0].students[0].scoreM,
        com: currentReg.groups[0].students[0].com
      } : null
    });

    // Rendre les groupes
    container.innerHTML = renderSwapGroups(currentReg.groups);

    // Activer le drag & drop
    enableDragAndDrop();
  }

  /**
   * Active le drag & drop pour les √©l√®ves
   */
  function enableDragAndDrop() {
    let draggedElement = null;
    let draggedData = null;

    // √âv√©nements sur les cartes √©l√®ves
    document.querySelectorAll('.swap-student-card').forEach(card => {
      card.addEventListener('dragstart', (e) => {
        draggedElement = e.target;
        draggedData = {
          groupIndex: parseInt(e.target.dataset.groupIndex),
          studentIndex: parseInt(e.target.dataset.studentIndex),
          studentId: e.target.dataset.studentId
        };
        e.target.style.opacity = '0.5';
      });

      card.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
      });
    });

    // √âv√©nements sur les zones de drop (listes d'√©l√®ves)
    document.querySelectorAll('.swap-students-list').forEach(list => {
      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        list.style.background = '#f3e8ff';
      });

      list.addEventListener('dragleave', (e) => {
        list.style.background = '';
      });

      list.addEventListener('drop', (e) => {
        e.preventDefault();
        list.style.background = '';

        if (!draggedData) return;

        const targetGroupIndex = parseInt(list.dataset.groupIndex);
        const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];

        if (!currentReg) return;

        // D√©placer l'√©l√®ve
        const sourceGroup = currentReg.groups[draggedData.groupIndex];
        const targetGroup = currentReg.groups[targetGroupIndex];

        if (sourceGroup && targetGroup) {
          const student = sourceGroup.students.splice(draggedData.studentIndex, 1)[0];
          if (student) {
            targetGroup.students.push(student);

            // Re-rendre l'interface
            renderCurrentRegroupement();
            updateSidebarPanel();
            updateStatsComparison();

            console.log(`‚úÖ √âl√®ve ${student.lastName} d√©plac√© du groupe ${draggedData.groupIndex + 1} vers ${targetGroupIndex + 1}`);
          }
        }
      });
    });
  }

  /**
   * Met √† jour le panneau des statistiques
   */
  function updateStatsPanel() {
    const content = document.getElementById('stats-panel-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      content.innerHTML = '<p style="color: #9ca3af;">Aucune donn√©e</p>';
      return;
    }

    // Calculer les statistiques globales
    const totalStudents = currentReg.groups.reduce((sum, g) => sum + g.students.length, 0);
    const totalGirls = currentReg.groups.reduce((sum, g) => sum + g.students.filter(s => s.sexe === 'F').length, 0);
    const totalBoys = totalStudents - totalGirls;

    const avgScoreF = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.scoreF) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgScoreM = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.scoreM) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgCOM = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.com) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgTRA = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.tra) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgPART = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.part) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    const avgABS = totalStudents > 0
      ? (currentReg.groups.reduce((sum, g) =>
          sum + g.students.reduce((s, st) => s + (parseFloat(st.abs) || 0), 0), 0) / totalStudents).toFixed(2)
      : '0.00';

    content.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 16px;">

        <!-- Effectifs -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
          border-radius: 8px;
          border-left: 4px solid #3b82f6;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">
            <i class="fas fa-users"></i> Effectifs
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>Total :</strong> ${totalStudents} √©l√®ves</div>
            <div><strong>Filles :</strong> ${totalGirls} (${(totalStudents > 0 ? (totalGirls / totalStudents * 100) : 0).toFixed(1)}%)</div>
            <div><strong>Gar√ßons :</strong> ${totalBoys} (${(totalStudents > 0 ? (totalBoys / totalStudents * 100) : 0).toFixed(1)}%)</div>
            <div><strong>Groupes :</strong> ${currentReg.groups.length}</div>
          </div>
        </div>

        <!-- Scores acad√©miques -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border-radius: 8px;
          border-left: 4px solid #f59e0b;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 12px;">
            <i class="fas fa-chart-line"></i> Scores acad√©miques
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>Moy Fran√ßais :</strong> ${avgScoreF} / 4</div>
            <div><strong>Moy Maths :</strong> ${avgScoreM} / 4</div>
          </div>
        </div>

        <!-- Crit√®res comportementaux -->
        <div style="
          padding: 16px;
          background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
          border-radius: 8px;
          border-left: 4px solid #8b5cf6;
        ">
          <div style="font-size: 14px; font-weight: 700; color: #6b21a8; margin-bottom: 12px;">
            <i class="fas fa-clipboard-check"></i> Crit√®res comportementaux
          </div>
          <div style="font-size: 13px; color: #374151; line-height: 1.8;">
            <div><strong>COM :</strong> ${avgCOM} / 4</div>
            <div><strong>TRA :</strong> ${avgTRA} / 4</div>
            <div><strong>PART :</strong> ${avgPART} / 4</div>
            <div><strong>ABS :</strong> ${avgABS} / 4</div>
          </div>
        </div>

      </div>
    `;
  }

  /**
   * Met √† jour le panneau lat√©ral (distribution)
   */
  function updateSidebarPanel() {
    const content = document.getElementById('sidebar-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg) {
      content.innerHTML = '<p style="color: #9ca3af; font-size: 13px;">Aucune donn√©e</p>';
      return;
    }

    const totalStudents = currentReg.groups.reduce((sum, g) => sum + g.students.length, 0);
    const totalGirls = currentReg.groups.reduce((sum, g) => sum + g.students.filter(s => s.sexe === 'F').length, 0);
    const totalBoys = totalStudents - totalGirls;

    // Distribution des scores pour chaque groupe
    const groupDistributions = currentReg.groups.map(group => {
      const scoreF = group.students.length > 0
        ? group.students.reduce((sum, s) => sum + (parseFloat(s.scoreF) || 0), 0) / group.students.length
        : 0;
      const scoreM = group.students.length > 0
        ? group.students.reduce((sum, s) => sum + (parseFloat(s.scoreM) || 0), 0) / group.students.length
        : 0;

      return {
        name: group.name,
        scoreF: scoreF.toFixed(2),
        scoreM: scoreM.toFixed(2),
        girls: group.students.filter(s => s.sexe === 'F').length,
        boys: group.students.filter(s => s.sexe === 'M').length
      };
    });

    content.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 20px;">

        <!-- Parit√© -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-balance-scale"></i> Parit√© F/M
          </h4>
          <div style="
            padding: 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
          ">
            ${totalGirls}F / ${totalBoys}M
            <div style="font-size: 12px; font-weight: 400; margin-top: 4px;">
              (${(totalStudents > 0 ? (totalGirls / totalStudents * 100) : 0).toFixed(1)}% / ${(totalStudents > 0 ? (totalBoys / totalStudents * 100) : 0).toFixed(1)}%)
            </div>
          </div>
        </div>

        <!-- Distribution Fran√ßais -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-book"></i> Distribution Fran√ßais
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${groupDistributions.map(dist => {
              const score = parseFloat(dist.scoreF);
              const percentage = (score / 4) * 100;
              const color = score >= 3 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';

              return `
                <div>
                  <div style="font-size: 12px; margin-bottom: 5px; color: #374151; font-weight: 600;">
                    ${dist.name}: <strong style="color: ${color};">${dist.scoreF}</strong>
                  </div>
                  <div style="
                    width: 100%;
                    height: 12px;
                    background: #e5e7eb;
                    border-radius: 6px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                  ">
                    <div style="
                      width: ${percentage}%;
                      height: 100%;
                      background: ${color};
                      transition: width 0.3s;
                      box-shadow: 0 2px 4px ${color}40;
                    "></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Distribution Maths -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-calculator"></i> Distribution Maths
          </h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${groupDistributions.map(dist => {
              const score = parseFloat(dist.scoreM);
              const percentage = (score / 4) * 100;
              const color = score >= 3 ? '#10b981' : score >= 2 ? '#f59e0b' : '#ef4444';

              return `
                <div>
                  <div style="font-size: 12px; margin-bottom: 5px; color: #374151; font-weight: 600;">
                    ${dist.name}: <strong style="color: ${color};">${dist.scoreM}</strong>
                  </div>
                  <div style="
                    width: 100%;
                    height: 12px;
                    background: #e5e7eb;
                    border-radius: 6px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                  ">
                    <div style="
                      width: ${percentage}%;
                      height: 100%;
                      background: ${color};
                      transition: width 0.3s;
                      box-shadow: 0 2px 4px ${color}40;
                    "></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Moyennes crit√®res -->
        <div>
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">
            <i class="fas fa-chart-bar"></i> Moyennes des crit√®res
          </h4>
          <div style="
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.8;
          ">
            ${currentReg.groups.map(group => {
              const avgCOM = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.com) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgTRA = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.tra) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgPART = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.part) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';
              const avgABS = group.students.length > 0
                ? (group.students.reduce((sum, s) => sum + (parseFloat(s.abs) || 0), 0) / group.students.length).toFixed(1)
                : '0.0';

              return `
                <div style="margin-bottom: 8px;">
                  <div style="font-weight: 600; color: #6366f1; margin-bottom: 4px;">
                    ${group.name}
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: #6b7280;">
                    <div>COM: ${avgCOM}</div>
                    <div>TRA: ${avgTRA}</div>
                    <div>PART: ${avgPART}</div>
                    <div>ABS: ${avgABS}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

      </div>
    `;
  }

  /**
   * Met √† jour le bandeau de comparaison des stats
   */
  function updateStatsComparison() {
    const content = document.getElementById('stats-comparison-content');
    if (!content) return;

    const currentReg = state.swapDashboard.allRegroupements[state.swapDashboard.currentRegroupementIndex];
    if (!currentReg || currentReg.groups.length === 0) {
      content.innerHTML = '<p style="color: #9ca3af; font-size: 13px;">Aucune donn√©e</p>';
      return;
    }

    // Calculer les stats pour chaque groupe
    const groupStats = currentReg.groups.map(group => {
      const total = group.students.length;
      const girls = group.students.filter(s => s.sexe === 'F').length;
      const boys = total - girls;
      const parityRatio = total > 0 ? (girls / total * 100).toFixed(0) : 0;

      const avgScoreF = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreF) || 0), 0) / total).toFixed(2)
        : '0.00';
      const avgScoreM = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.scoreM) || 0), 0) / total).toFixed(2)
        : '0.00';
      const avgCOM = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.com) || 0), 0) / total).toFixed(1)
        : '0.0';
      const avgTRA = total > 0
        ? (group.students.reduce((sum, s) => sum + (parseFloat(s.tra) || 0), 0) / total).toFixed(1)
        : '0.0';

      return {
        name: group.name,
        total,
        girls,
        boys,
        parityRatio,
        avgScoreF,
        avgScoreM,
        avgCOM,
        avgTRA
      };
    });

    content.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        ${groupStats.map((stats, index) => {
          // Couleur de la parit√© (vert si 40-60%, orange si 30-70%, rouge sinon)
          const parityColor = (stats.parityRatio >= 40 && stats.parityRatio <= 60) ? '#10b981'
            : (stats.parityRatio >= 30 && stats.parityRatio <= 70) ? '#f59e0b'
            : '#ef4444';

          return `
            <div style="
              background: white;
              border: 2px solid #d1d5db;
              border-radius: 10px;
              padding: 14px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              transition: all 0.2s;
            " onmouseover="this.style.borderColor='#6d28d9'; this.style.boxShadow='0 4px 12px rgba(109, 40, 217, 0.15)'" onmouseout="this.style.borderColor='#d1d5db'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)'">
              <div style="font-size: 15px; font-weight: 700; color: #6d28d9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.3px;">
                ${stats.name}
              </div>

              <!-- Parit√© -->
              <div style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
                padding: 6px;
                background: ${parityColor}15;
                border-left: 3px solid ${parityColor};
                border-radius: 4px;
              ">
                <i class="fas fa-balance-scale" style="color: ${parityColor};"></i>
                <span style="font-size: 13px; font-weight: 600; color: #374151;">
                  ${stats.girls}F / ${stats.boys}M
                </span>
                <span style="
                  margin-left: auto;
                  padding: 2px 6px;
                  background: ${parityColor};
                  color: white;
                  border-radius: 4px;
                  font-size: 11px;
                  font-weight: 600;
                ">
                  ${stats.parityRatio}%
                </span>
              </div>

              <!-- Scores -->
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <div style="
                  flex: 1;
                  padding: 8px;
                  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                  border-radius: 6px;
                  text-align: center;
                  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                ">
                  <div style="font-size: 10px; color: #dbeafe; font-weight: 600; letter-spacing: 0.5px;">FRAN√áAIS</div>
                  <div style="font-size: 16px; font-weight: 700; color: white; margin-top: 2px;">${stats.avgScoreF}</div>
                </div>
                <div style="
                  flex: 1;
                  padding: 8px;
                  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                  border-radius: 6px;
                  text-align: center;
                  box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                ">
                  <div style="font-size: 10px; color: #fef3c7; font-weight: 600; letter-spacing: 0.5px;">MATHS</div>
                  <div style="font-size: 16px; font-weight: 700; color: white; margin-top: 2px;">${stats.avgScoreM}</div>
                </div>
              </div>

              <!-- Crit√®res comportementaux -->
              <div style="
                display: flex;
                justify-content: space-around;
                padding: 6px;
                background: #f9fafb;
                border-radius: 4px;
                font-size: 11px;
                color: #6b7280;
              ">
                <div><strong>COM</strong> ${stats.avgCOM}</div>
                <div><strong>TRA</strong> ${stats.avgTRA}</div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  /**
   * Attache les √©v√©nements au dashboard
   */
  function attachDashboardEvents() {
    // Fermer
    const closeBtn = document.getElementById('close-dashboard');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        document.getElementById('swap-dashboard').remove();
      });
    }

    // Navigation regroupements
    const prevBtn = document.getElementById('btn-prev-regroupement');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => navigateRegroupement(-1));
    }

    const nextBtn = document.getElementById('btn-next-regroupement');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => navigateRegroupement(1));
    }

    // Toggle stats panel
    const statsBtn = document.getElementById('btn-toggle-stats');
    if (statsBtn) {
      statsBtn.addEventListener('click', toggleStatsPanel);
    }

    // Toggle sidebar
    const sidebarBtn = document.getElementById('btn-toggle-sidebar');
    if (sidebarBtn) {
      sidebarBtn.addEventListener('click', toggleSidebar);
    }

    // Toggle bandeau comparaison
    const comparisonBtn = document.getElementById('btn-toggle-comparison');
    if (comparisonBtn) {
      comparisonBtn.addEventListener('click', toggleComparisonBanner);
    }

    // Boutons sauvegardes (placeholder)
    document.getElementById('btn-load')?.addEventListener('click', () => {
      alert('Fonctionnalit√© "Charger" √† venir');
    });

    document.getElementById('btn-save-temp')?.addEventListener('click', () => {
      alert('Sauvegarde temporaire effectu√©e (fonctionnalit√© √† venir)');
    });

    document.getElementById('btn-finalize')?.addEventListener('click', () => {
      if (confirm('Finaliser ce regroupement ? Les donn√©es seront sauvegard√©es de mani√®re permanente.')) {
        alert('Regroupement finalis√© (fonctionnalit√© √† venir)');
      }
    });

    // Boutons exports (placeholder)
    document.getElementById('btn-export-pdf')?.addEventListener('click', () => {
      alert('Export PDF √† venir');
    });

    document.getElementById('btn-export-csv')?.addEventListener('click', () => {
      alert('Export CSV √† venir');
    });

    // R√©g√©n√©rer (placeholder)
    document.getElementById('btn-regenerate')?.addEventListener('click', () => {
      if (confirm('R√©g√©n√©rer ce regroupement ? Les modifications manuelles seront perdues.')) {
        alert('R√©g√©n√©ration √† venir');
      }
    });
  }

  /**
   * Navigue entre les regroupements
   */
  function navigateRegroupement(direction) {
    const newIndex = state.swapDashboard.currentRegroupementIndex + direction;

    if (newIndex < 0 || newIndex >= state.swapDashboard.allRegroupements.length) {
      return; // Hors limites
    }

    state.swapDashboard.currentRegroupementIndex = newIndex;

    // Re-rendre tout
    renderCurrentRegroupement();
    updateStatsPanel();
    updateSidebarPanel();
    updateStatsComparison();

    // Mettre √† jour les boutons de navigation
    const prevBtn = document.getElementById('btn-prev-regroupement');
    const nextBtn = document.getElementById('btn-next-regroupement');

    if (prevBtn) {
      prevBtn.disabled = newIndex === 0;
      prevBtn.style.opacity = newIndex === 0 ? '0.5' : '1';
      prevBtn.style.cursor = newIndex === 0 ? 'not-allowed' : 'pointer';
    }

    if (nextBtn) {
      nextBtn.disabled = newIndex === state.swapDashboard.allRegroupements.length - 1;
      nextBtn.style.opacity = newIndex === state.swapDashboard.allRegroupements.length - 1 ? '0.5' : '1';
      nextBtn.style.cursor = newIndex === state.swapDashboard.allRegroupements.length - 1 ? 'not-allowed' : 'pointer';
    }

    console.log(`üîÑ Navigation: regroupement ${newIndex + 1} / ${state.swapDashboard.allRegroupements.length}`);
  }

  /**
   * Toggle du panneau statistiques
   */
  function toggleStatsPanel() {
    state.swapDashboard.statsVisible = !state.swapDashboard.statsVisible;

    const panel = document.getElementById('stats-panel');
    const btn = document.getElementById('btn-toggle-stats');

    if (panel) {
      panel.style.left = state.swapDashboard.statsVisible ? '0' : '-350px';
    }

    if (btn) {
      btn.style.background = state.swapDashboard.statsVisible
        ? '#3b82f6'
        : 'rgba(255, 255, 255, 0.2)';
    }
  }

  /**
   * Toggle du panneau lat√©ral
   */
  function toggleSidebar() {
    state.swapDashboard.sidebarCollapsed = !state.swapDashboard.sidebarCollapsed;

    const panel = document.getElementById('sidebar-panel');
    const content = document.getElementById('sidebar-content');
    const btn = document.getElementById('btn-toggle-sidebar');

    if (panel) {
      panel.style.width = state.swapDashboard.sidebarCollapsed ? '60px' : '320px';
      panel.style.padding = state.swapDashboard.sidebarCollapsed ? '16px 8px' : '24px';
    }

    if (content) {
      content.style.display = state.swapDashboard.sidebarCollapsed ? 'none' : 'block';
    }

    if (btn) {
      btn.innerHTML = `<i class="fas fa-chevron-${state.swapDashboard.sidebarCollapsed ? 'left' : 'right'}"></i>`;
    }
  }

  /**
   * Toggle du bandeau de comparaison
   */
  function toggleComparisonBanner() {
    state.swapDashboard.comparisonVisible = !state.swapDashboard.comparisonVisible;

    const content = document.getElementById('stats-comparison-content');
    const btn = document.getElementById('btn-toggle-comparison');

    if (!content || !btn) return;

    if (state.swapDashboard.comparisonVisible) {
      // D√©plier
      content.style.display = 'block';
      btn.innerHTML = '<i class="fas fa-chevron-up"></i> R√©duire';
    } else {
      // R√©duire
      content.style.display = 'none';
      btn.innerHTML = '<i class="fas fa-chevron-down"></i> Afficher';
    }
  }

  /**
   * Affiche une erreur
   */
  function displayError(error) {
    alert('Erreur : ' + error.message);
    addToTimeline(`Erreur : ${error.message}`);
  }

  // API publique
  return {
    renderInitialStructure,
    displayResults,
    displayError,
    state
  };
})();

// Export pour utilisation dans le module
if (typeof window !== 'undefined') {
  window.GroupsInterfaceV4 = GroupsInterfaceV4;
  console.log('‚úÖ GroupsInterfaceV4 charg√©');
}
</script>
