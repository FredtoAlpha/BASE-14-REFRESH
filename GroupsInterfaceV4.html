<script>
/**
 * GROUPS INTERFACE V4 - TRIPTYQUE
 * Interface utilisateur en trois volets pour la cr√©ation de groupes
 * Architecture : Volet A (30%) - Volet B (40%) - Volet C (30%)
 */

const GroupsInterfaceV4 = (function() {
  'use strict';

  // √âtat interne de l'interface
  const state = {
    scenario: null,        // 'besoins' | 'lv2' | 'options'
    mode: null,           // 'heterogeneous' | 'homogeneous'
    selectedLanguage: null, // 'ESP' | 'ITA' | 'ALL' | 'CHI' | 'ARA' | etc.
    availableLanguages: [], // [{ lang: 'ESP', count: 45 }, ...]
    regroupements: [],    // Liste des regroupements configur√©s
    currentResults: null, // R√©sultats de la g√©n√©ration en cours
    timeline: [],         // Historique des actions
    carouselIndex: 0      // Index du carrousel de groupes
  };

  /**
   * Rendu de la structure HTML compl√®te (triptyque 30/40/30)
   */
  function renderInitialStructure(container) {
    container.innerHTML = `
      <div class="groups-v4-triptyque" style="display: flex; height: 100vh; background: #f8f9fa;">

        <!-- VOLET A : Param√®tres (30%) -->
        <div class="volet-a" style="flex: 0 0 30%; background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%); border-right: 1px solid #e5e7eb; overflow-y: auto;">
          <div style="padding: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #1f2937; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-cog"></i> Param√®tres
            </h2>

            <!-- Sc√©nario -->
            <div style="margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                Choisir un sc√©nario
              </h3>
              <div id="scenario-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <button class="scenario-btn" data-scenario="besoins" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-user-graduate"></i> Besoins p√©dagogiques
                </button>
                <button class="scenario-btn" data-scenario="lv2" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-language"></i> Langues vivantes (LV2)
                </button>
                <button class="scenario-btn" data-scenario="options" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-star"></i> Options sp√©cifiques
                </button>
              </div>
            </div>

            <!-- Mode de distribution -->
            <div id="mode-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                Mode de distribution
              </h3>
              <div id="mode-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <button class="mode-btn" data-mode="heterogeneous" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-random"></i> H√©t√©rog√®ne
                  <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    M√©lange les niveaux pour √©quilibrer
                  </div>
                </button>
                <button class="mode-btn" data-mode="homogeneous" style="
                  padding: 12px 16px;
                  border: 2px solid #e5e7eb;
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                  text-align: left;
                  transition: all 0.2s;
                ">
                  <i class="fas fa-equals"></i> Homog√®ne
                  <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    Groupes de niveaux similaires
                  </div>
                </button>
              </div>
            </div>

            <!-- S√©lection de la langue LV2 -->
            <div id="language-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-language"></i> Langue √† regrouper
              </h3>
              <div id="language-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Les langues seront ins√©r√©es ici dynamiquement -->
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> <span id="language-info">S√©lectionnez une langue</span>
              </div>
            </div>

            <!-- Classes d√©tect√©es -->
            <div id="classes-detected-section" style="display: none; margin-bottom: 32px;">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-school"></i> Classes d√©tect√©es
              </h3>
              <div id="classes-detected-list" style="
                padding: 12px;
                background: #f0fdf4;
                border: 1px solid #86efac;
                border-radius: 8px;
                font-size: 13px;
              ">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <!-- Les classes d√©tect√©es s'afficheront ici -->
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> Ces classes sont disponibles pour cr√©er des regroupements
              </div>
            </div>

            <!-- Aide contextuelle -->
            <div id="help-box" style="
              padding: 12px;
              background: #eff6ff;
              border-left: 4px solid #3b82f6;
              border-radius: 4px;
              font-size: 13px;
              color: #1e40af;
              display: none;
            ">
              <i class="fas fa-info-circle"></i>
              <span id="help-text"></span>
            </div>
          </div>
        </div>

        <!-- VOLET B : Regroupements (40%) -->
        <div class="volet-b" style="flex: 0 0 40%; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); overflow-y: auto;">
          <div style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="fas fa-layer-group"></i> Regroupements
              </h2>
              <button id="btn-add-regroupement" style="
                padding: 8px 16px;
                background: #10b981;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: none;
              ">
                <i class="fas fa-plus"></i> Ajouter
              </button>
            </div>

            <div id="regroupements-list" style="display: flex; flex-direction: column; gap: 16px;">
              <div id="regroupements-placeholder" style="
                padding: 48px 24px;
                text-align: center;
                color: #9ca3af;
                border: 2px dashed #e5e7eb;
                border-radius: 8px;
              ">
                <i class="fas fa-arrow-left" style="font-size: 24px; margin-bottom: 16px;"></i>
                <div style="font-size: 14px;">
                  S√©lectionnez un sc√©nario et un mode pour commencer
                </div>
              </div>
            </div>

            <!-- Bandeau d'actions -->
            <div id="actions-banner" style="
              display: none;
              margin-top: 24px;
              padding: 16px;
              background: white;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
            ">
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="btn-reset" style="
                  padding: 10px 20px;
                  background: #ef4444;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                ">
                  <i class="fas fa-redo"></i> R√©initialiser
                </button>
                <button id="btn-generate" style="
                  padding: 10px 20px;
                  background: #3b82f6;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 500;
                ">
                  <i class="fas fa-magic"></i> G√©n√©rer les groupes
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- VOLET C : R√©capitulatif (30%) -->
        <div class="volet-c" style="flex: 0 0 30%; background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%); border-left: 1px solid #e5e7eb; overflow-y: auto;">
          <div style="padding: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              <i class="fas fa-chart-bar"></i> R√©capitulatif
            </h2>

            <!-- Sc√©nario et mode s√©lectionn√©s -->
            <div id="recap-selection" style="
              padding: 16px;
              background: #f9fafb;
              border-radius: 8px;
              margin-bottom: 24px;
              font-size: 14px;
            ">
              <div style="margin-bottom: 8px;">
                <strong>Sc√©nario :</strong> <span id="recap-scenario">-</span>
              </div>
              <div style="margin-bottom: 8px;">
                <strong>Mode :</strong> <span id="recap-mode">-</span>
              </div>
              <div id="recap-language-row" style="display: none;">
                <strong>Langue :</strong> <span id="recap-language">-</span>
              </div>
            </div>

            <!-- Statistiques -->
            <div id="recap-stats" style="display: none; margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-chart-pie"></i> Statistiques
              </h3>
              <div id="stats-content"></div>
            </div>

            <!-- Timeline -->
            <div id="recap-timeline" style="margin-bottom: 24px;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-clock"></i> Timeline
              </h3>
              <div id="timeline-content" style="
                font-size: 13px;
                color: #6b7280;
              ">
                Aucune action pour le moment
              </div>
            </div>

            <!-- Aper√ßu des groupes (carrousel) -->
            <div id="recap-groups" style="display: none;">
              <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #374151;">
                <i class="fas fa-users"></i> Aper√ßu des groupes
              </h3>
              <div id="groups-carousel"></div>
            </div>

            <!-- Interface de swap -->
            <div id="recap-swap-section" style="display: none; margin-top: 24px;">
              <button id="btn-open-swap" style="
                width: 100%;
                padding: 14px 20px;
                background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                transition: all 0.2s;
              " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'">
                <i class="fas fa-exchange-alt"></i> Ouvrir l'interface de swap
              </button>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280; text-align: center;">
                <i class="fas fa-info-circle"></i> √âchangez les √©l√®ves entre les groupes
              </div>
            </div>
          </div>
        </div>

      </div>
    `;

    // Initialiser les √©v√©nements
    initializeEvents(container);
  }

  /**
   * Initialise les √©v√©nements de l'interface
   */
  function initializeEvents(container) {
    // Boutons de sc√©nario
    container.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => selectScenario(btn.dataset.scenario));
    });

    // Boutons de mode
    container.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => selectMode(btn.dataset.mode));
    });

    // Bouton ajouter regroupement
    const btnAdd = container.querySelector('#btn-add-regroupement');
    if (btnAdd) {
      btnAdd.addEventListener('click', addRegroupement);
    }

    // Bouton g√©n√©rer
    const btnGenerate = container.querySelector('#btn-generate');
    if (btnGenerate) {
      btnGenerate.addEventListener('click', generateGroups);
    }

    // Bouton r√©initialiser
    const btnReset = container.querySelector('#btn-reset');
    if (btnReset) {
      btnReset.addEventListener('click', resetInterface);
    }

    // Bouton ouvrir swap interface
    const btnOpenSwap = container.querySelector('#btn-open-swap');
    if (btnOpenSwap) {
      btnOpenSwap.addEventListener('click', openSwapInterface);
    }
  }

  /**
   * S√©lection du sc√©nario
   */
  function selectScenario(scenario) {
    state.scenario = scenario;

    // Mettre √† jour l'UI
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      if (btn.dataset.scenario === scenario) {
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#eff6ff';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section mode
    const modeSection = document.getElementById('mode-section');
    if (modeSection) modeSection.style.display = 'block';

    // Si sc√©nario LV2, afficher le s√©lecteur de langue
    if (scenario === 'lv2') {
      displayLanguageSelection();
    } else {
      // Masquer la section langue pour les autres sc√©narios
      const languageSection = document.getElementById('language-section');
      if (languageSection) languageSection.style.display = 'none';
      state.selectedLanguage = null;
    }

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Sc√©nario "${scenario}" s√©lectionn√©`);

    console.log('‚úÖ Sc√©nario s√©lectionn√©:', scenario);
  }

  /**
   * S√©lection du mode
   */
  function selectMode(mode) {
    state.mode = mode;

    // Mettre √† jour l'UI
    document.querySelectorAll('.mode-btn').forEach(btn => {
      if (btn.dataset.mode === mode) {
        btn.style.borderColor = '#10b981';
        btn.style.background = '#f0fdf4';
      } else {
        btn.style.borderColor = '#e5e7eb';
        btn.style.background = 'white';
      }
    });

    // Afficher la section des classes d√©tect√©es
    displayDetectedClasses();

    // Activer le volet B
    activateVoletB();

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Mode "${mode}" s√©lectionn√©`);

    console.log('‚úÖ Mode s√©lectionn√©:', mode);
  }

  /**
   * Affiche la liste des classes d√©tect√©es depuis le DOM
   */
  function displayDetectedClasses() {
    const section = document.getElementById('classes-detected-section');
    const listContainer = document.querySelector('#classes-detected-list > div');

    if (!section || !listContainer) return;

    // D√©tecter les classes depuis le DOM
    const zones = document.querySelectorAll('.droppable-zone[data-classe]');
    const classes = [];
    zones.forEach(zone => {
      const className = zone.getAttribute('data-classe');
      if (className && !classes.includes(className)) {
        classes.push(className);
      }
    });

    if (classes.length === 0) {
      listContainer.innerHTML = '<span style="color: #ef4444;">Aucune classe d√©tect√©e</span>';
    } else {
      listContainer.innerHTML = classes.map(className => `
        <span style="
          display: inline-block;
          padding: 4px 10px;
          background: white;
          border: 1px solid #10b981;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          color: #059669;
        ">
          <i class="fas fa-graduation-cap" style="margin-right: 4px;"></i>${className}
        </span>
      `).join('');
    }

    // Afficher la section
    section.style.display = 'block';

    console.log(`‚úÖ ${classes.length} classe(s) d√©tect√©e(s):`, classes);
  }

  /**
   * D√©tecte les langues LV2 disponibles depuis les donn√©es
   */
  function detectAvailableLanguages() {
    if (!window.STATE || !window.STATE.students) {
      console.warn('‚ö†Ô∏è STATE.students non disponible pour d√©tecter les langues');
      return [];
    }

    // Compter les √©l√®ves par langue
    const languageCounts = {};

    Object.values(window.STATE.students).forEach(student => {
      const lang = (student.lv2 || student.LV2 || 'ESP').toUpperCase();
      languageCounts[lang] = (languageCounts[lang] || 0) + 1;
    });

    // Convertir en tableau
    const languages = Object.entries(languageCounts).map(([lang, count]) => ({
      lang,
      count
    }));

    // Trier par nombre d'√©l√®ves d√©croissant
    languages.sort((a, b) => b.count - a.count);

    console.log('üåç Langues d√©tect√©es:', languages);
    return languages;
  }

  /**
   * Affiche le s√©lecteur de langues
   */
  function displayLanguageSelection() {
    const section = document.getElementById('language-section');
    const buttonsContainer = document.getElementById('language-buttons');
    const infoSpan = document.getElementById('language-info');

    if (!section || !buttonsContainer || !infoSpan) return;

    // D√©tecter les langues disponibles
    state.availableLanguages = detectAvailableLanguages();

    if (state.availableLanguages.length === 0) {
      buttonsContainer.innerHTML = '<p style="color: #ef4444; font-size: 13px;">Aucune langue d√©tect√©e</p>';
      section.style.display = 'block';
      return;
    }

    // Afficher les langues sous forme de boutons
    buttonsContainer.innerHTML = state.availableLanguages.map(({ lang, count }) => {
      const langNames = {
        'ESP': 'Espagnol üá™üá∏',
        'ITA': 'Italien üáÆüáπ',
        'ALL': 'Allemand üá©üá™',
        'CHI': 'Chinois üá®üá≥',
        'ARA': 'Arabe üá¶üá™'
      };
      const displayName = langNames[lang] || `${lang} üåç`;

      return `
        <button class="language-btn" data-language="${lang}" style="
          padding: 12px 16px;
          border: 2px solid ${state.selectedLanguage === lang ? '#8b5cf6' : '#e5e7eb'};
          border-radius: 8px;
          background: ${state.selectedLanguage === lang ? '#f3e8ff' : 'white'};
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span style="font-weight: ${state.selectedLanguage === lang ? '600' : '400'};">
            ${displayName}
          </span>
          <span style="
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
          ">
            ${count}
          </span>
        </button>
      `;
    }).join('');

    // Mettre √† jour le texte d'info
    if (state.selectedLanguage) {
      const selectedLang = state.availableLanguages.find(l => l.lang === state.selectedLanguage);
      if (selectedLang) {
        infoSpan.textContent = `${selectedLang.count} √©l√®ve(s) en ${state.selectedLanguage}`;
      }
    } else {
      infoSpan.textContent = 'S√©lectionnez une langue';
    }

    // Afficher la section
    section.style.display = 'block';

    // Attacher les √©v√©nements
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', () => selectLanguage(btn.dataset.language));
    });
  }

  /**
   * S√©lectionne une langue
   */
  function selectLanguage(language) {
    state.selectedLanguage = language;

    // Mettre √† jour l'UI
    displayLanguageSelection();

    // Mettre √† jour le r√©capitulatif
    updateRecap();

    // Ajouter √† la timeline
    addToTimeline(`Langue "${language}" s√©lectionn√©e`);

    console.log('‚úÖ Langue s√©lectionn√©e:', language);
  }

  /**
   * Active le volet B (regroupements)
   */
  function activateVoletB() {
    const placeholder = document.getElementById('regroupements-placeholder');
    const btnAdd = document.getElementById('btn-add-regroupement');
    const actionsBanner = document.getElementById('actions-banner');

    if (placeholder) placeholder.style.display = 'none';
    if (btnAdd) btnAdd.style.display = 'inline-block';
    if (actionsBanner) actionsBanner.style.display = 'block';
  }

  /**
   * Ajoute un regroupement
   */
  function addRegroupement() {
    const regroupement = {
      id: Date.now(),
      name: `Regroupement ${state.regroupements.length + 1}`,
      classes: [],
      numGroups: 3
    };

    state.regroupements.push(regroupement);
    renderRegroupements();
    addToTimeline(`Regroupement "${regroupement.name}" ajout√©`);
  }

  /**
   * Rendu de la liste des regroupements
   */
  function renderRegroupements() {
    const list = document.getElementById('regroupements-list');
    if (!list) return;

    // R√©cup√©rer les classes disponibles depuis window.STATE
    const availableClasses = [];
    if (window.STATE && window.STATE.students) {
      const zones = document.querySelectorAll('.droppable-zone[data-classe]');
      zones.forEach(zone => {
        const className = zone.getAttribute('data-classe');
        if (className && !availableClasses.includes(className)) {
          availableClasses.push(className);
        }
      });
    }

    list.innerHTML = state.regroupements.map(reg => `
      <div class="regroupement-card" data-id="${reg.id}" style="
        padding: 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <input
            type="text"
            value="${reg.name}"
            data-id="${reg.id}"
            class="regroupement-name"
            style="
              font-weight: 500;
              border: none;
              background: transparent;
              outline: none;
              font-size: 14px;
            "
          />
          <div style="display: flex; gap: 8px;">
            <button class="btn-duplicate" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
            ">
              <i class="fas fa-copy"></i>
            </button>
            <button class="btn-delete" data-id="${reg.id}" style="
              padding: 4px 8px;
              border: 1px solid #e5e7eb;
              background: white;
              border-radius: 4px;
              cursor: pointer;
              color: #ef4444;
            ">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- S√©lection des classes -->
        <div style="margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px;">
            S√©lectionner les classes :
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${availableClasses.map(className => `
              <label style="
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                border: 2px solid ${reg.classes && reg.classes.includes(className) ? '#3b82f6' : '#e5e7eb'};
                background: ${reg.classes && reg.classes.includes(className) ? '#eff6ff' : 'white'};
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
              ">
                <input
                  type="checkbox"
                  class="class-checkbox"
                  data-regroupement-id="${reg.id}"
                  data-class-name="${className}"
                  ${reg.classes && reg.classes.includes(className) ? 'checked' : ''}
                  style="margin-right: 6px;"
                />
                ${className}
              </label>
            `).join('')}
          </div>
        </div>

        <div style="font-size: 13px; color: #6b7280;">
          <div style="margin-bottom: 8px;">
            <strong>Classes s√©lectionn√©es :</strong>
            <span id="classes-${reg.id}">
              ${reg.classes && reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune'}
            </span>
          </div>
          <div style="margin-top: 8px;">
            Nombre de groupes :
            <input
              type="number"
              value="${reg.numGroups}"
              min="2"
              max="10"
              data-id="${reg.id}"
              class="num-groups-input"
              style="
                width: 60px;
                padding: 4px 8px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                text-align: center;
              "
            />
          </div>
        </div>
      </div>
    `).join('');

    // R√©attacher les √©v√©nements
    attachRegroupementEvents();
  }

  /**
   * Attache les √©v√©nements aux cartes de regroupement
   */
  function attachRegroupementEvents() {
    // Checkboxes de s√©lection de classes
    document.querySelectorAll('.class-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const regId = parseInt(e.target.dataset.regroupementId);
        const className = e.target.dataset.className;
        const reg = state.regroupements.find(r => r.id === regId);

        if (reg) {
          if (!reg.classes) reg.classes = [];

          if (e.target.checked) {
            if (!reg.classes.includes(className)) {
              reg.classes.push(className);
            }
          } else {
            reg.classes = reg.classes.filter(c => c !== className);
          }

          // Mettre √† jour l'affichage
          const display = document.getElementById(`classes-${regId}`);
          if (display) {
            display.textContent = reg.classes.length > 0 ? reg.classes.join(', ') : 'Aucune';
          }

          addToTimeline(`"${reg.name}" : ${reg.classes.length} classe(s) s√©lectionn√©e(s)`);
        }
      });
    });

    // Renommer
    document.querySelectorAll('.regroupement-name').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.name = e.target.value;
          addToTimeline(`"${reg.name}" renomm√©`);
        }
      });
    });

    // Changer le nombre de groupes
    document.querySelectorAll('.num-groups-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          reg.numGroups = parseInt(e.target.value);
          addToTimeline(`"${reg.name}" : ${reg.numGroups} groupes`);
        }
      });
    });

    // Dupliquer
    document.querySelectorAll('.btn-duplicate').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg) {
          const duplicate = {
            ...reg,
            id: Date.now(),
            name: `${reg.name} (copie)`,
            classes: [...(reg.classes || [])]
          };
          state.regroupements.push(duplicate);
          renderRegroupements();
          addToTimeline(`"${duplicate.name}" cr√©√© par duplication`);
        }
      });
    });

    // Supprimer
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = parseInt(e.target.closest('button').dataset.id);
        const reg = state.regroupements.find(r => r.id === id);
        if (reg && confirm(`Supprimer "${reg.name}" ?`)) {
          state.regroupements = state.regroupements.filter(r => r.id !== id);
          renderRegroupements();
          addToTimeline(`"${reg.name}" supprim√©`);
        }
      });
    });
  }

  /**
   * G√©n√®re les groupes
   */
  function generateGroups() {
    if (!state.scenario || !state.mode) {
      alert('Veuillez s√©lectionner un sc√©nario et un mode');
      return;
    }

    // Pour LV2, v√©rifier qu'une langue est s√©lectionn√©e
    if (state.scenario === 'lv2' && !state.selectedLanguage) {
      alert('Veuillez s√©lectionner une langue pour le sc√©nario LV2');
      return;
    }

    if (state.regroupements.length === 0) {
      alert('Veuillez ajouter au moins un regroupement');
      return;
    }

    // √âmettre l'√©v√©nement
    const event = new CustomEvent('groups:generate', {
      detail: {
        scenario: state.scenario,
        mode: state.mode,
        selectedLanguage: state.selectedLanguage, // Ajout de la langue s√©lectionn√©e
        regroupements: state.regroupements
      }
    });

    document.dispatchEvent(event);
    console.log('üöÄ √âv√©nement groups:generate √©mis', event.detail);

    addToTimeline('G√©n√©ration des groupes lanc√©e...');
  }

  /**
   * R√©initialise l'interface
   */
  function resetInterface() {
    if (!confirm('R√©initialiser tous les regroupements ?')) return;

    state.regroupements = [];
    state.currentResults = null;
    renderRegroupements();
    addToTimeline('Interface r√©initialis√©e');
  }

  /**
   * Met √† jour le r√©capitulatif
   */
  function updateRecap() {
    const recapScenario = document.getElementById('recap-scenario');
    const recapMode = document.getElementById('recap-mode');
    const recapLanguageRow = document.getElementById('recap-language-row');
    const recapLanguage = document.getElementById('recap-language');

    if (recapScenario) {
      recapScenario.textContent = state.scenario || '-';
    }

    if (recapMode) {
      recapMode.textContent = state.mode || '-';
    }

    // Afficher la langue si sc√©nario LV2
    if (recapLanguageRow && recapLanguage) {
      if (state.scenario === 'lv2') {
        recapLanguageRow.style.display = 'block';
        recapLanguage.textContent = state.selectedLanguage || '-';
      } else {
        recapLanguageRow.style.display = 'none';
      }
    }
  }

  /**
   * Ajoute une entr√©e √† la timeline
   */
  function addToTimeline(message) {
    const timestamp = new Date().toLocaleTimeString('fr-FR');
    state.timeline.push({ timestamp, message });

    const timelineContent = document.getElementById('timeline-content');
    if (timelineContent) {
      const entry = document.createElement('div');
      entry.style.marginBottom = '8px';
      entry.innerHTML = `
        <span style="color: #9ca3af;">[${timestamp}]</span>
        ${message}
      `;
      timelineContent.appendChild(entry);

      // Scroll vers le bas
      timelineContent.scrollTop = timelineContent.scrollHeight;
    }
  }

  /**
   * Affiche les r√©sultats de g√©n√©ration
   */
  function displayResults(results) {
    state.currentResults = results;

    // Afficher les statistiques
    const statsSection = document.getElementById('recap-stats');
    const statsContent = document.getElementById('stats-content');

    if (statsSection && statsContent) {
      statsSection.style.display = 'block';
      statsContent.innerHTML = `
        <div style="font-size: 13px;">
          <div style="margin-bottom: 4px;">
            <strong>Groupes g√©n√©r√©s :</strong> ${results.stats.length}
          </div>
          <div style="margin-bottom: 4px;">
            <strong>Total √©l√®ves :</strong> ${results.metadata.totalStudents}
          </div>
        </div>
      `;
    }

    // Afficher la section swap
    const swapSection = document.getElementById('recap-swap-section');
    if (swapSection) {
      swapSection.style.display = 'block';
    }

    addToTimeline(`${results.stats.length} groupes g√©n√©r√©s avec succ√®s`);
  }

  /**
   * Ouvre l'interface de swap
   */
  function openSwapInterface() {
    if (!state.currentResults || !state.currentResults.groups) {
      alert('Aucun groupe √† afficher. Veuillez d\'abord g√©n√©rer les groupes.');
      return;
    }

    // Cr√©er le modal de swap
    const modal = document.createElement('div');
    modal.id = 'swap-interface-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    `;

    // Construire le contenu
    content.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 700; margin: 0; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          <i class="fas fa-exchange-alt"></i> Interface de Swap
        </h2>
        <button id="close-swap-modal" style="
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #9ca3af;
          transition: color 0.2s;
        " onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#9ca3af'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #eff6ff 0%, #f3e8ff 100%); border-radius: 12px; border-left: 4px solid #8b5cf6;">
        <p style="margin: 0; font-size: 14px; color: #4c1d95;">
          <i class="fas fa-info-circle"></i> Glissez-d√©posez les √©l√®ves entre les groupes pour les r√©organiser
        </p>
      </div>

      <div id="swap-groups-container" style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      ">
        ${renderSwapGroups(state.currentResults.groups)}
      </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // Fermer le modal
    document.getElementById('close-swap-modal').addEventListener('click', () => {
      modal.remove();
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });

    console.log('‚úÖ Interface de swap ouverte');
  }

  /**
   * Rendu des groupes dans l'interface de swap
   */
  function renderSwapGroups(groups) {
    return groups.map((group, groupIndex) => `
      <div class="swap-group" data-group-index="${groupIndex}" style="
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s;
      ">
        <h3 style="
          font-size: 16px;
          font-weight: 700;
          margin: 0 0 16px 0;
          padding-bottom: 12px;
          border-bottom: 2px solid #8b5cf6;
          color: #6366f1;
        ">
          ${group.name}
          <span style="font-size: 12px; font-weight: 400; color: #6b7280; margin-left: 8px;">
            (${group.students.length} √©l√®ves)
          </span>
        </h3>
        <div class="swap-students-list" data-group-index="${groupIndex}" style="
          min-height: 100px;
          display: flex;
          flex-direction: column;
          gap: 8px;
        ">
          ${group.students.map((student, studentIndex) => `
            <div
              class="swap-student-card"
              draggable="true"
              data-group-index="${groupIndex}"
              data-student-index="${studentIndex}"
              data-student-id="${student.id}"
              style="
                padding: 10px 12px;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                cursor: move;
                font-size: 13px;
                transition: all 0.2s;
              "
              onmouseover="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.2)'"
              onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            >
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-grip-vertical" style="color: #9ca3af;"></i>
                <span style="font-weight: 600; color: #374151;">
                  ${student.lastName} ${student.firstName}
                </span>
                ${student.class ? `
                  <span style="
                    font-size: 11px;
                    padding: 2px 6px;
                    background: #dbeafe;
                    color: #1e40af;
                    border-radius: 4px;
                    margin-left: auto;
                  ">${student.class}</span>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');
  }

  /**
   * Affiche une erreur
   */
  function displayError(error) {
    alert('Erreur : ' + error.message);
    addToTimeline(`Erreur : ${error.message}`);
  }

  // API publique
  return {
    renderInitialStructure,
    displayResults,
    displayError,
    state
  };
})();

// Export pour utilisation dans le module
if (typeof window !== 'undefined') {
  window.GroupsInterfaceV4 = GroupsInterfaceV4;
  console.log('‚úÖ GroupsInterfaceV4 charg√©');
}
</script>
